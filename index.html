<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gouvernance ILOCC - Restitution</title>
    
    <!-- Import Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Chart.js for Vision Tab -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Import Google Fonts: Oswald & Georgia -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- Import Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Styles for D.I.X. Charter -->
    <style>
        :root {
            --dix-dark: #405F59;
            --dix-light: #549e39;
            --dix-white: #f3f3f3;
        }

        body {
            font-family: 'Georgia', serif;
            color: var(--dix-dark);
            background-color: var(--dix-white);
        }

        .font-oswald {
            font-family: 'Oswald', sans-serif;
        }
        
        .font-georgia {
            font-family: 'Georgia', serif;
        }

        /* Colors Utility Classes override */
        .text-dix-dark { color: var(--dix-dark); }
        .bg-dix-dark { background-color: var(--dix-dark); }
        .border-dix-dark { border-color: var(--dix-dark); }
        
        .text-dix-light { color: var(--dix-light); }
        .bg-dix-light { background-color: var(--dix-light); }
        .border-dix-light { border-color: var(--dix-light); }
        
        .text-dix-white { color: var(--dix-white); }
        .bg-dix-white { background-color: var(--dix-white); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #aaa; }

        .actor-btn.active {
            background-color: var(--dix-white);
            border-color: var(--dix-dark);
            color: var(--dix-dark);
        }

        /* Tab Navigation Styles */
        .nav-tab {
            position: relative;
            transition: all 0.3s ease;
            opacity: 0.7;
        }
        .nav-tab:hover { opacity: 1; }
        .nav-tab.active { opacity: 1; font-weight: 500; }
        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px; left: 0; width: 100%; height: 4px;
            background-color: var(--dix-light);
        }

        /* --- STYLES SP√âCIFIQUES MATRICE (Refonte D.I.X.) --- */
        .matrix-container table {
            border-collapse: separate;
            border-spacing: 0;
        }
        .matrix-container th {
            font-family: 'Oswald', sans-serif;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.85rem;
            color: var(--dix-white);
            background-color: var(--dix-dark);
            border-right: 1px solid rgba(255,255,255,0.1);
            padding: 16px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 30;
        }
        /* Sticky first column header */
        .matrix-container th:first-child {
            position: sticky;
            left: 0;
            z-index: 40;
            background-color: var(--dix-dark);
            border-right: 2px solid var(--dix-light);
        }
        .matrix-container td {
            font-family: 'Georgia', serif;
            font-size: 0.85rem;
            color: var(--dix-dark);
            padding: 16px;
            background-color: white;
            border-bottom: 1px solid rgba(64, 95, 89, 0.1);
            border-right: 1px solid rgba(64, 95, 89, 0.05);
            vertical-align: top;
            line-height: 1.4;
        }
        /* Sticky first column body */
        .matrix-container td:first-child {
            position: sticky;
            left: 0;
            z-index: 20;
            background-color: var(--dix-white);
            font-family: 'Oswald', sans-serif;
            text-transform: uppercase;
            font-weight: 500;
            font-size: 0.8rem;
            border-right: 2px solid var(--dix-light);
            color: var(--dix-dark);
        }
        .matrix-container tr:hover td {
            background-color: rgba(84, 158, 57, 0.05);
        }
        /* Highlight column style (Representation) - D.I.X version */
        .matrix-container td:nth-child(2) {
            background-color: rgba(84, 158, 57, 0.03);
            font-weight: bold;
            color: var(--dix-dark);
        }

        /* --- STYLES SP√âCIFIQUES FILI√àRE --- */
        .filiere-grid {
            display: grid;
            grid-template-columns: 80px repeat(5, 1fr);
            grid-template-rows: auto auto auto auto;
            gap: 12px;
            align-items: stretch;
        }

        .node-base {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            border: 1px solid #E5E7EB;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 95px; /* Increased height */
            padding: 10px 30px 10px 12px; /* Increased padding */
            border-radius: 4px;
        }
        .node-base:hover {
            border-color: var(--dix-light);
            box-shadow: 0 4px 10px -2px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
            z-index: 60;
        }

        .is-member-highlight {
            border-color: var(--dix-light) !important;
            box-shadow: 0 0 15px rgba(84, 158, 57, 0.3) !important;
            transform: scale(1.05);
            z-index: 40;
        }
        .not-member-dimmed {
            opacity: 0.25;
            filter: grayscale(0.8);
        }

        .actor-icon-strip {
            position: absolute;
            right: 4px; top: 0; bottom: 0;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            gap: 1px; font-size: 1rem; /* Increased size significantly */
            border-left: 1px solid rgba(229, 231, 235, 0.5);
            padding-left: 4px;
            background: linear-gradient(to left, rgba(255,255,255,0.95), transparent);
            width: 24px;
        }

        .row-header {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            display: flex; align-items: center; justify-content: center;
            font-family: 'Oswald', sans-serif;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 1rem; /* Increased size significantly */
            letter-spacing: 0.1em;
            padding: 10px;
            position: relative;
        }

        .header-ovine { background: #EFF6FF; color: #1E40AF; margin-bottom: -6px; }
        .header-caprine { background: #ECFDF5; color: #065F46; margin-top: -6px; }
        .header-pivot {
            background: linear-gradient(to bottom, #EFF6FF, #ECFDF5);
            grid-row: 3; grid-column: 1;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem; color: var(--dix-dark); font-weight: 800; z-index: 5; /* Increased size */
            font-family: 'Oswald', sans-serif;
        }

        .col-header {
            font-size: 0.95rem; font-family: 'Oswald', sans-serif; /* Increased size */
            text-transform: uppercase; color: #9CA3AF;
            text-align: center; padding-bottom: 8px;
            border-bottom: 2px solid #E5E7EB;
        }

        .amont-block { background-color: rgba(240, 253, 244, 0.4); padding: 10px; border-radius: 4px; }
        .aval-block { background-color: rgba(239, 246, 255, 0.4); padding: 10px; border-radius: 4px; }

        .key-term { font-size: 0.75rem; color: #6B7280; font-style: italic; margin-top: 2px; line-height: 1.1; font-family: 'Georgia', serif; } /* Increased size */
        .member-indicator { position: absolute; top: 4px; left: 4px; color: var(--dix-light); font-size: 0.75rem; font-weight: 900; } /* Increased size */

        /* Stats Bars */
        .stat-bar-container {
            width: 100%; background-color: #F3F4F6;
            border-radius: 9999px; height: 8px;
            overflow: hidden; margin-top: 4px;
        }
        .stat-bar-fill {
            height: 100%; border-radius: 9999px;
            transition: width 1.5s ease-in-out;
        }
        
        /* LOGIN OVERLAY STYLES */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--dix-dark);
            z-index: 10005; /* Max Z */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .login-box {
            background-color: white;
            padding: 2rem;
            border-radius: 4px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .login-input {
            width: 100%;
            padding: 10px;
            margin: 15px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: 'Georgia', serif;
        }
        
        .login-btn {
            background-color: var(--dix-light);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Oswald', sans-serif;
            text-transform: uppercase;
            font-weight: 500;
            width: 100%;
            transition: background-color 0.2s;
        }
        
        .login-btn:hover {
            background-color: #468c2f;
        }
        
        .error-msg {
            color: #d32f2f;
            font-size: 0.8rem;
            margin-top: 10px;
            display: none;
        }

        /* --- KANBAN / ROADMAP STYLES --- */
        .roadmap-container {
            display: flex;
            overflow-x: auto;
            height: 100%;
            padding-bottom: 20px;
            gap: 16px;
        }
        
        .roadmap-col {
            min-width: 320px; /* Slightly wider */
            width: 320px;
            background-color: #f3f3f3;
            border-radius: 6px;
            border: 1px solid rgba(64, 95, 89, 0.1);
            display: flex;
            flex-direction: column;
            max-height: 100%;
        }
        
        .roadmap-header {
            padding: 12px 16px;
            background-color: var(--dix-dark);
            color: white;
            border-radius: 6px 6px 0 0;
            font-family: 'Oswald', sans-serif;
            text-transform: uppercase;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .roadmap-body {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .roadmap-card {
            background: white;
            padding: 16px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-top: 4px solid var(--dix-light); /* Changed to top border */
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .roadmap-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        /* Action Item Style inside Objective Card */
        .action-item-mini {
            display: flex;
            align-items: start;
            gap: 8px;
            font-size: 0.75rem;
            color: #4b5563;
            background-color: #f9fafb;
            padding: 6px;
            border-radius: 4px;
            margin-top: 4px;
            border-left: 2px solid #eab308;
        }
        
        .add-card-btn {
            margin: 12px;
            padding: 10px;
            border: 2px dashed #cbd5e1;
            border-radius: 4px;
            text-align: center;
            color: #64748b;
            font-size: 0.8rem;
            cursor: pointer;
            font-family: 'Oswald', sans-serif;
            text-transform: uppercase;
            transition: all 0.2s;
            background: rgba(255,255,255,0.5);
        }
        
        .add-card-btn:hover {
            background-color: white;
            border-color: var(--dix-light);
            color: var(--dix-light);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 100;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(2px);
        }
        .modal-content {
            background: white; width: 90%; max-width: 600px;
            border-radius: 6px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            overflow: hidden; animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* TUTORIAL STYLES */
        .tour-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); z-index: 10000;
            transition: opacity 0.3s;
        }
        .tour-target {
            position: relative; z-index: 10002 !important;
            background: white; border-radius: 4px;
            box-shadow: 0 0 0 4px rgba(84, 158, 57, 0.8);
        }
        .tour-tooltip {
            position: fixed; z-index: 10005; /* Always on top */
            background: white; color: #333;
            padding: 16px; border-radius: 8px;
            width: 280px; box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            border-left: 4px solid var(--dix-light);
            animation: fadeIn 0.3s ease-out;
        }
        .tour-tooltip h4 { font-family: 'Oswald', sans-serif; font-size: 1.1rem; color: var(--dix-dark); margin-bottom: 8px; }
        .tour-tooltip p { font-family: 'Georgia', serif; font-size: 0.9rem; line-height: 1.4; color: #555; }
        .tour-nav { display: flex; justify-content: flex-end; margin-top: 12px; gap: 8px; }
        .tour-btn { padding: 4px 12px; font-size: 0.75rem; text-transform: uppercase; font-family: 'Oswald'; border-radius: 4px; cursor: pointer; }
        .tour-btn-next { background: var(--dix-light); color: white; }
        .tour-btn-skip { color: #888; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay">
        <div class="login-box">
            <div class="mb-4 flex justify-center">
                <!-- Using an image tag for the logo -->
                <img src="https://custom-images.strikinglycdn.com/res/hrscywv4p/image/upload/c_limit,fl_lossy,h_300,w_300,f_auto,q_auto/1094382/568385_347809.png" alt="Logo" class="w-16 h-16 object-contain">
            </div>
            <h2 class="font-oswald text-xl text-dix-dark mb-2 uppercase">Acc√®s Restreint</h2>
            <p class="text-sm text-gray-500 mb-4 font-georgia">Veuillez entrer le mot de passe pour acc√©der √† la restitution.</p>
            <input type="password" id="password-input" class="login-input" placeholder="Mot de passe">
            <button onclick="checkPassword()" class="login-btn">Entrer</button>
            <p id="login-error" class="error-msg font-georgia">Mot de passe incorrect</p>
        </div>
    </div>

    <!-- HEADER & NAVIGATION -->
    <header class="bg-dix-dark text-dix-white flex-none h-16 shadow-md z-20 flex items-center justify-between px-6 border-b border-dix-light">
        <div class="flex items-center gap-3">
            <!-- Modified logo container: w-12 h-12 (48px) with padding -->
            <div class="bg-white rounded-full flex items-center justify-center w-12 h-12 shadow-sm p-1.5 overflow-hidden">
                <!-- Using w-full h-full object-contain to fit perfectly inside the padded container -->
                <img src="https://custom-images.strikinglycdn.com/res/hrscywv4p/image/upload/c_limit,fl_lossy,h_300,w_300,f_auto,q_auto/1094382/568385_347809.png" alt="Logo" class="w-full h-full object-contain">
            </div>

            <!-- LOGO PARTENAIRE - D√âPLAC√â ICI -->
            <div class="bg-white p-0.5 rounded-sm h-10 flex items-center shadow-sm">
                <img src="https://s1.qwant.com/thumbr/474x149/a/b/08bbfa8f31ba6f41a07653b19db7702132086cd9d82d095bd955a0eee95a72/OIP.8CeO6ec9tpxlNWfRlPzXrAHaCV.jpg?u=https%3A%2F%2Ftse.mm.bing.net%2Fth%2Fid%2FOIP.8CeO6ec9tpxlNWfRlPzXrAHaCV%3Fpid%3DApi&q=0&b=1&p=0&a=0" alt="Partenaire" class="h-full w-auto object-contain">
            </div>

            <div class="ml-2">
                <h1 class="font-oswald uppercase text-xl tracking-wide leading-none">Commission Strat√©gie et gouvernance de L'ILOCC</h1>
                <p class="text-[10px] font-georgia italic opacity-70">restitution atelier #1 _ R√¥le de L'ILOCC </p>
            </div>
        </div>

        <nav class="flex h-full">
            <button onclick="switchTab('acteurs')" id="nav-acteurs" class="nav-tab active h-full px-6 flex items-center gap-2 font-oswald uppercase tracking-wider text-sm">
                <i data-lucide="users" class="w-4 h-4"></i> Acteurs
            </button>
            <button onclick="switchTab('matrice')" id="nav-matrice" class="nav-tab h-full px-6 flex items-center gap-2 font-oswald uppercase tracking-wider text-sm">
                <i data-lucide="table" class="w-4 h-4"></i> Matrice
            </button>
            <button onclick="switchTab('filiere')" id="nav-filiere" class="nav-tab h-full px-6 flex items-center gap-2 font-oswald uppercase tracking-wider text-sm">
                <i data-lucide="git-merge" class="w-4 h-4"></i> Fili√®re
            </button>
            <!-- NOUVEL ONGLET ATTENTES (D√©plac√© ici) -->
            <button onclick="switchTab('attentes')" id="nav-attentes" class="nav-tab h-full px-6 flex items-center gap-2 font-oswald uppercase tracking-wider text-sm">
                <i data-lucide="message-circle" class="w-4 h-4"></i> Attentes
            </button>
            <button onclick="switchTab('vision')" id="nav-vision" class="nav-tab h-full px-6 flex items-center gap-2 font-oswald uppercase tracking-wider text-sm">
                <i data-lucide="eye" class="w-4 h-4"></i> Vision
            </button>
            <!-- NOUVEL ONGLET ROADMAP -->
            <button onclick="switchTab('roadmap')" id="nav-roadmap" class="nav-tab h-full px-6 flex items-center gap-2 font-oswald uppercase tracking-wider text-sm">
                <i data-lucide="kanban" class="w-4 h-4"></i> Feuille de Route
            </button>
        </nav>

        <div class="w-32 flex justify-end">
             <button onclick="toggleLexicon(true)" class="flex items-center gap-2 text-xs font-oswald uppercase opacity-80 hover:opacity-100 hover:text-dix-light transition-colors">
                <i data-lucide="book" class="w-4 h-4"></i> Lexique
            </button>
        </div>
    </header>

    <!-- MODAL ADD OBJECTIVE (ROADMAP) -->
    <div id="roadmap-modal" class="modal-overlay">
        <div class="modal-content flex flex-col">
            <div class="p-4 border-b border-[#549e39] bg-[#f3f3f3] flex justify-between items-center">
                <h3 class="font-oswald uppercase text-lg text-dix-dark">D√©finir un Objectif</h3>
                <button onclick="document.getElementById('roadmap-modal').style.display='none'" class="text-dix-dark hover:text-red-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 bg-white space-y-4">
                <input type="hidden" id="modal-axis-id">
                <div>
                    <label class="block text-xs font-oswald uppercase text-gray-500 mb-1">Axe Strat√©gique</label>
                    <input type="text" id="modal-axis-name" disabled class="w-full p-2 bg-gray-100 border border-gray-200 rounded text-sm text-dix-dark font-medium">
                </div>
                <div>
                    <label class="block text-xs font-oswald uppercase text-gray-500 mb-1">Intitul√© de l'objectif</label>
                    <input type="text" id="modal-title" class="w-full p-2 border border-gray-300 rounded text-sm font-georgia" placeholder="Ex: Cr√©er un observatoire des prix...">
                </div>
                <div>
                    <label class="block text-xs font-oswald uppercase text-gray-500 mb-1">Description & Indicateurs de r√©ussite</label>
                    <textarea id="modal-desc" rows="3" class="w-full p-2 border border-gray-300 rounded text-sm font-georgia" placeholder="Quel est le r√©sultat attendu ?"></textarea>
                </div>
            </div>
            <div class="p-4 bg-[#f3f3f3] border-t border-gray-200 flex justify-end gap-2">
                <button onclick="document.getElementById('roadmap-modal').style.display='none'" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 font-oswald uppercase">Annuler</button>
                <button id="btn-save-roadmap" class="px-4 py-2 bg-[#549e39] text-white rounded text-sm font-oswald uppercase hover:bg-[#468c2f]">Cr√©er l'objectif</button>
            </div>
        </div>
    </div>

    <!-- MODAL DETAILS & ACTIONS -->
    <div id="details-modal" class="modal-overlay">
        <div class="modal-content flex flex-col h-[85vh] max-w-3xl"> <!-- Taller and Wider modal -->
            <div class="p-4 border-b border-[#549e39] bg-[#f3f3f3] flex justify-between items-center">
                <h3 class="font-oswald uppercase text-lg text-dix-dark">Fiche Objectif</h3>
                <button onclick="closeDetailsModal()" class="text-dix-dark hover:text-red-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 bg-white">
                <!-- Content injected via JS -->
                <div id="details-content" class="space-y-6"></div>
                
                <!-- Actions Section -->
                <div class="mt-8 pt-6 border-t-2 border-gray-100">
                    <h4 class="font-oswald uppercase text-base text-dix-dark mb-4 flex items-center gap-2">
                        <i data-lucide="list-todo" class="w-5 h-5 text-amber-600"></i>
                        Plan d'Actions Op√©rationnel
                    </h4>
                    
                    <div id="actions-list" class="space-y-3 mb-6">
                        <!-- Actions injected here -->
                    </div>

                    <!-- Add Action Form -->
                    <div class="bg-amber-50/50 p-4 rounded border border-amber-200">
                        <p class="text-xs font-oswald text-amber-700 mb-3 uppercase tracking-wide">Ajouter une action concr√®te pour servir cet objectif</p>
                        <div class="grid grid-cols-2 gap-3 mb-2">
                            <input type="text" id="action-title" class="col-span-2 w-full p-2 border border-gray-300 rounded text-sm font-georgia" placeholder="Intitul√© de l'action (ex: Embaucher un animateur)">
                            <input type="text" id="action-means" class="w-full p-2 border border-gray-300 rounded text-sm font-georgia" placeholder="Moyens / Leviers (ex: Budget, Groupe de travail)">
                            <input type="text" id="action-partner" class="w-full p-2 border border-gray-300 rounded text-sm font-georgia" placeholder="Partenaires associ√©s">
                        </div>
                        <div class="text-right">
                            <button id="btn-add-action" class="px-3 py-1.5 bg-amber-600 text-white text-xs font-oswald uppercase rounded hover:bg-amber-700">Ajouter l'action</button>
                        </div>
                    </div>
                </div>

                <!-- Comments Section -->
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <h4 class="font-oswald uppercase text-sm text-dix-dark mb-4 flex items-center gap-2">
                        <i data-lucide="message-square-plus" class="w-4 h-4 text-gray-400"></i>
                        Notes & Compl√©ments
                    </h4>
                    
                    <div id="notes-list" class="space-y-3 mb-6">
                        <!-- Notes injected here -->
                    </div>

                    <div class="bg-gray-50 p-4 rounded border border-gray-200">
                        <input type="text" id="note-author" class="w-full p-2 mb-2 border border-gray-300 rounded text-sm font-georgia" placeholder="Votre Nom / Structure">
                        <textarea id="note-text" rows="2" class="w-full p-2 mb-2 border border-gray-300 rounded text-sm font-georgia" placeholder="Votre remarque..."></textarea>
                        <div class="text-right">
                            <button id="btn-add-note" class="px-3 py-1.5 bg-gray-600 text-white text-xs font-oswald uppercase rounded hover:bg-gray-700">Ajouter note</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL LEXIQUE (Global) -->
    <div id="lexicon-modal" class="fixed inset-0 z-50 bg-[#405F59] bg-opacity-50 backdrop-blur-sm hidden items-center justify-center p-4">
        <div class="bg-white shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col border border-dix-dark">
            <div class="p-4 border-b border-[#549e39] flex justify-between items-center bg-[#f3f3f3]">
                <h3 class="font-oswald uppercase text-xl flex items-center gap-2 text-dix-dark font-normal">
                    <i data-lucide="book" class="w-5 h-5 text-dix-light"></i>
                    Lexique & Acronymes
                </h3>
                <button onclick="toggleLexicon(false)" class="p-1 hover:bg-gray-200 rounded-full transition-colors">
                    <i data-lucide="x" class="w-5 h-5 text-dix-dark"></i>
                </button>
            </div>
            <div id="lexicon-content" class="overflow-y-auto p-6 space-y-4 font-georgia bg-white">
                <!-- Lexicon items will be injected here -->
            </div>
            <div class="p-4 bg-[#f3f3f3] border-t border-[#549e39] text-center text-xs text-dix-dark opacity-60 font-oswald uppercase">
                D√©finitions contextuelles √† la fili√®re laiti√®re corse
            </div>
        </div>
    </div>

    <!-- MAIN CONTAINER FOR TABS -->
    <div class="flex-1 relative overflow-hidden bg-dix-white">
        
        <!-- ONGLET 1: ACTEURS (D.I.X. MASTER-DETAIL) -->
        <div id="tab-acteurs" class="tab-pane absolute inset-0 flex">
            <!-- SIDEBAR ACTEURS -->
            <div class="w-1/3 min-w-[300px] bg-white border-r border-[#549e39]/30 flex flex-col shadow-sm z-10">
                <!-- Header Sidebar -->
                <div class="p-6 border-b border-[#549e39]/30 bg-[#f3f3f3]">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-xl font-oswald uppercase font-normal flex items-center gap-2 text-dix-dark">
                                <i data-lucide="list" class="w-5 h-5 text-dix-light"></i>
                                Liste des Structures
                            </h2>
                        </div>
                    </div>
                </div>

                <!-- Search & Filter -->
                <div class="p-4 bg-[#f3f3f3] border-b border-[#549e39]/30 space-y-3">
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-dix-dark opacity-40"></i>
                        <input 
                            type="text" 
                            id="search-input"
                            placeholder="Rechercher une structure..." 
                            class="w-full pl-9 pr-4 py-2 text-sm border border-dix-dark/20 focus:outline-none focus:ring-1 focus:ring-[#549e39] transition-all bg-white font-georgia text-dix-dark placeholder-dix-dark/50"
                        >
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="flex items-center gap-2 text-sm text-dix-dark cursor-pointer select-none font-georgia">
                            <input type="checkbox" id="filter-member" class="accent-[#549e39]">
                            Membres ILOCC uniquement
                        </label>
                    </div>
                </div>

                <!-- Actor List -->
                <div id="actor-list" class="flex-1 overflow-y-auto p-2 space-y-1 bg-white">
                    <!-- Actors will be injected here -->
                </div>
            </div>

            <!-- MAIN CONTENT ACTEURS -->
            <div id="main-content" class="flex-1 overflow-y-auto bg-[#f3f3f3] p-8">
                <!-- Actor details will be injected here -->
                <div class="h-full flex items-center justify-center text-dix-dark opacity-30 font-georgia italic">
                    S√©lectionnez une structure pour voir les d√©tails
                </div>
            </div>
        </div>

        <!-- ONGLET 2: MATRICE (Refonte compl√®te D.I.X.) -->
        <div id="tab-matrice" class="tab-pane absolute inset-0 hidden p-8 bg-[#fdfbf7] flex flex-col h-full overflow-hidden">
            <div class="mb-6 flex-none">
                <h2 class="font-oswald text-3xl text-dix-dark uppercase font-normal tracking-wide">Matrice des Responsabilit√©s</h2>
                <p class="font-georgia text-dix-dark opacity-60 italic mt-1">Synth√®se des positionnements des acteurs par grand domaine d'action</p>
            </div>
            
            <div class="flex-1 overflow-auto bg-white border border-dix-light/30 shadow-sm relative matrix-container">
                <table class="w-full min-w-[1000px]">
                    <thead>
                        <tr>
                            <th class="w-64">Structure</th>
                            <th>Repr√©sentation</th>
                            <th>Gouvernance</th>
                            <th>Technique</th>
                            <th>Sanitaire / Qualit√©</th>
                            <th>√âconomie / March√©</th>
                        </tr>
                    </thead>
                    <tbody id="matrix-body">
                        <!-- Injected via JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ONGLET 3: FILI√àRE (Interactive Graph) -->
        <div id="tab-filiere" class="tab-pane absolute inset-0 hidden overflow-auto p-8 bg-[#fdfbf7]">
             <!-- Modification ici : min-h-full pour permettre l'expansion et grand padding-bottom (pb-48) -->
             <div class="space-y-12 min-h-full pb-48"> 
            
                <div class="flex justify-center">
                    <div class="flex flex-col items-center text-center">
                        <div id="hub-ilocc" 
                             onmouseover="highlightInterproMembers()" 
                             onmouseout="clearMemberHighlight()"
                             onclick="selectAndGo(1)" 
                             class="w-64 h-32 bg-white rounded border-4 border-[#549e39] shadow-lg flex flex-col items-center justify-center text-center p-4 node-base z-50"> <!-- Increased size -->
                            <div class="actor-icon-strip">‚öñÔ∏è<br>‚öôÔ∏è</div>
                            <span class="text-2xl font-oswald text-dix-dark leading-tight uppercase">ILOCC</span>
                            <p class="key-term text-[#549e39] font-bold uppercase text-[12px]">Gouvernance & Strat√©gie</p>
                        </div>
                        <p class="text-[11px] text-[#549e39] mt-2 italic animate-pulse text-center font-georgia">Survolez l'ILOCC pour voir ses membres</p>
                    </div>
                </div>
    
                <div class="filiere-grid">
                    <!-- Headers -->
                    <div style="grid-row: 1; grid-column: 1;"></div>
                    <div class="col-header" style="grid-row: 1; grid-column: 2;">G√©n√©tique</div>
                    <div class="col-header" style="grid-row: 1; grid-column: 3;">Sanitaire</div>
                    <div class="col-header" style="grid-row: 1; grid-column: 4;">Transformation</div>
                    <div class="col-header" style="grid-row: 1; grid-column: 5;">Qualit√©</div>
                    <div class="col-header" style="grid-row: 1; grid-column: 6;">Promotion / Com</div>
    
                    <!-- Row 2: Fili√®re Ovine -->
                    <div class="row-header header-ovine" style="grid-row: 2; grid-column: 1;">Fili√®re Ovine</div>
                    <div class="amont-block flex flex-col gap-2" style="grid-row: 2; grid-column: 2;">
                        <div onclick="selectAndGo(7)" class="node-base"><div class="actor-icon-strip">üêë</div><span class="font-bold text-[14px] uppercase font-oswald text-center leading-tight">OS CORSE</span><p class="key-term text-[11px] text-center leading-tight">S√©lection race</p></div>
                        <div onclick="selectAndGo(8)" class="node-base"><div class="actor-icon-strip">üêë</div><span class="font-bold text-[14px] uppercase text-center leading-tight font-oswald">CORSIA</span><p class="key-term text-[11px] text-center leading-tight">IA & B√©liers</p></div>
                    </div>
                    <div style="grid-row: 2; grid-column: 3;"></div>
                    <div class="aval-block flex items-center" style="grid-row: 2; grid-column: 4;">
                        <div onclick="selectAndGo(3)" class="node-base w-full border-red-100 is-interpro-member"><span class="member-indicator">‚òÖ</span><div class="actor-icon-strip">ü•©<br>üêë</div><span class="font-bold text-[14px] uppercase font-oswald text-center leading-tight">SCA AGNELLU</span><p class="key-term text-red-800 text-center text-[11px] leading-tight">Abattage & Valo</p></div>
                    </div>
                    <div class="aval-block flex flex-col gap-2" style="grid-row: 2; grid-column: 5;">
                        <!-- ODG BROCCIU removed here -->
                        <div onclick="selectAndGo(4)" class="node-base w-full border-blue-300 is-interpro-member"><span class="member-indicator">‚òÖ</span><div class="actor-icon-strip">ü•©</div><span class="font-bold text-[14px] uppercase leading-tight font-oswald text-center">AREO</span><p class="key-term text-center leading-tight text-[11px]">IGP Agneau</p></div>
                    </div>
                    <div class="aval-block flex items-center" style="grid-row: 2; grid-column: 6;">
                        <div onclick="selectAndGo(4)" class="node-base w-full border-blue-300 text-center is-interpro-member"><span class="member-indicator">‚òÖ</span><div class="actor-icon-strip">ü•©</div><span class="font-bold text-[14px] uppercase font-oswald text-center leading-tight">AREO</span><p class="key-term text-center text-left text-[11px] leading-tight">Mise en march√©</p></div>
                    </div>
    
                    <!-- Row 3: Zone Transversale -->
                    <div class="header-pivot">TRANSVERSAL</div>
                    <div class="amont-block flex items-center" style="grid-row: 3; grid-column: 3;">
                        <div onclick="selectAndGo(10)" class="node-base w-full border-red-200 shadow-sm"><div class="actor-icon-strip">üõ°Ô∏è</div><span class="font-bold text-[14px] uppercase text-red-900 leading-tight font-oswald text-center">GDS</span><p class="key-term font-bold text-red-700 text-center text-[11px] leading-tight">Expertise Sanitaire</p></div>
                    </div>
                    <div class="aval-block flex items-center" style="grid-row: 3; grid-column: 4;">
                        <div onclick="selectAndGo(6)" class="node-base w-full border-amber-300 bg-amber-50/30"><div class="actor-icon-strip">üßÄ<br>ü•õ</div><span class="font-bold text-[14px] uppercase text-amber-900 font-oswald text-center leading-tight">CASGIU CASANU</span><p class="key-term text-[11px] text-center leading-tight">Transfo. Fermi√®re</p></div>
                    </div>
                    <div class="aval-block flex items-center" style="grid-row: 3; grid-column: 5;">
                        <div onclick="selectAndGo(12)" class="node-base w-full border-blue-400 bg-blue-50/20 shadow-md"><div class="actor-icon-strip">üßÄ<br>üêë<br>üêê</div><span class="font-bold text-[14px] uppercase text-blue-900 leading-tight font-oswald text-center">ODG BROCCIU</span><p class="key-term text-blue-700 font-bold text-center text-[11px] leading-tight">Garant AOP</p></div>
                    </div>
                    <div class="aval-block flex items-center" style="grid-row: 3; grid-column: 6;">
                        <div onclick="selectAndGo(6)" class="node-base w-full border-amber-300 bg-amber-50/30"><div class="actor-icon-strip">üßÄ<br>ü•õ</div><span class="font-bold text-[14px] uppercase text-amber-900 font-oswald text-center leading-tight">CASGIU CASANU</span><p class="key-term text-[11px] text-center leading-tight">Promotion fermi√®re</p></div>
                    </div>
    
                    <!-- Row 4: Fili√®re Caprine -->
                    <div class="row-header header-caprine" style="grid-row: 4; grid-column: 1;">Fili√®re Caprine</div>
                    <div class="amont-block flex items-center" style="grid-row: 4; grid-column: 2;">
                        <div onclick="selectAndGo(9)" class="node-base w-full text-center is-interpro-member"><span class="member-indicator">‚òÖ</span><div class="actor-icon-strip">üêê</div><span class="font-bold text-[14px] uppercase font-oswald text-center leading-tight">ASSOC. CAPRAGHJI</span><p class="key-term text-center text-[11px] leading-tight">Sch√©ma s√©lection</p></div>
                    </div>
                    <div style="grid-row: 4; grid-column: 3;"></div>
                    <div style="grid-row: 4; grid-column: 4;"></div>
                    <div class="aval-block flex items-center" style="grid-row: 4; grid-column: 5;">
                        <div onclick="selectAndGo(9)" class="node-base w-full border-blue-300 is-interpro-member text-center"><span class="member-indicator">‚òÖ</span><div class="actor-icon-strip">ü•©</div><span class="font-bold text-[15px] uppercase font-oswald text-center leading-tight">ASSOC. CAPRAGHJI</span><p class="key-term text-center text-[11px] leading-tight">IGP Cabri</p></div>
                    </div>
                    <div class="aval-block flex items-center" style="grid-row: 4; grid-column: 6;">
                        <div onclick="selectAndGo(9)" class="node-base w-full border-blue-300 text-center is-interpro-member"><span class="member-indicator">‚òÖ</span><div class="actor-icon-strip">üêê</div><span class="font-bold text-[14px] uppercase font-black text-blue-900 font-oswald text-center leading-tight">ASSOC. CAPRAGHJI</span><p class="key-term text-blue-700 text-center text-[11px] leading-tight">Promotion</p></div>
                    </div>
                </div>
    
                <!-- Support & Repr√©sentation -->
                <!-- Modification ici : suppression de mb-32 sur le grid car inutile avec le spacer -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-12 mt-12 pt-8 border-t-2 border-gray-200">
                    <div>
                        <span class="font-oswald uppercase text-sm tracking-widest text-amber-700 mb-4 block">Repr√©sentation & D√©fense</span>
                        <div class="flex flex-wrap gap-3">
                            <div onclick="selectAndGo(2)" class="node-base w-48 bg-gray-50/50 min-h-0 py-2 is-interpro-member"><span class="member-indicator">‚òÖ</span><span class="font-bold text-[13px] uppercase font-oswald text-center leading-tight">GPC</span><p class="key-term text-[11px] text-center leading-tight">Revenu des √©leveurs</p></div>
                            <div onclick="selectAndGo(5)" class="node-base w-48 bg-gray-50/50 min-h-0 py-2 is-interpro-member"><span class="member-indicator">‚òÖ</span><span class="font-bold text-[13px] uppercase font-oswald text-center leading-tight">U CASGILE</span><p class="key-term text-[11px] text-center leading-tight">D√©fense OCC</p></div>
                            <div onclick="selectAndGo(11)" class="node-base w-48 bg-amber-50/50 min-h-0 py-2 border-amber-200 is-interpro-member"><span class="member-indicator">‚òÖ</span><span class="font-bold text-[13px] uppercase leading-tight font-oswald text-center">ASSOC. TRANSFORMATEURS</span><p class="key-term text-[11px] text-center leading-tight">D√©fense industrielle</p></div>
                        </div>
                    </div>
                    <div>
                        <span class="font-oswald uppercase text-sm tracking-widest text-purple-700 mb-4 block">Support, Financement & Institutionnel</span>
                        <div class="flex flex-wrap gap-3">
                            <div onclick="selectAndGo(14)" class="node-base w-48 border-purple-200 min-h-0 py-2 text-center"><span class="font-bold text-[13px] uppercase font-oswald text-center leading-tight">ODARC</span><p class="key-term text-[11px] text-center leading-tight">Financement & PAC</p></div>
                            <div onclick="selectAndGo(13)" class="node-base w-48 border-purple-200 min-h-0 py-2 text-center"><span class="font-bold text-[13px] uppercase leading-tight font-oswald text-center">CHAMBRE D'AGRICULTURE</span><p class="key-term text-[11px] text-center leading-tight">Accompagnement terrain</p></div>
                            <div onclick="selectAndGo(15)" class="node-base w-48 border-purple-200 min-h-0 py-2 text-center"><span class="font-bold text-[13px] uppercase font-oswald text-center leading-tight">FRANCEAGRIMER</span><p class="key-term text-[11px] text-center leading-tight">Tutelle de l'√âtat</p></div>
                        </div>
                    </div>
                </div>
                
                <!-- AJOUT DU SPACER -->
                <div class="h-40 w-full"></div>
            </div>
        </div>

        <!-- NOUVEL ONGLET: ATTENTES (Analyse d√©taill√©e) -->
        <div id="tab-attentes" class="tab-pane absolute inset-0 hidden overflow-auto p-8 bg-[#fdfbf7]">
            <div class="space-y-10 max-w-6xl mx-auto">
                <div class="mb-6 flex-none border-l-4 border-[#549e39] pl-6 py-2">
                    <h2 class="font-oswald text-3xl text-dix-dark uppercase font-normal tracking-wide">Analyse des Attentes</h2>
                    <p class="font-georgia text-dix-dark opacity-60 italic mt-1">Synth√®se d√©taill√©e et comparative des demandes exprim√©es par chaque acteur vis-√†-vis de l'ILOCC.</p>
                </div>

                <!-- Analyse S√©mantique (Dynamique) -->
                <div class="bg-white rounded border border-dix-light/30 p-6 shadow-sm">
                    <h3 class="font-oswald uppercase text-dix-dark text-sm tracking-widest mb-4 flex items-center gap-2">
                        <i data-lucide="tag" class="w-4 h-4 text-[#549e39]"></i>
                        Mots-cl√©s r√©currents dans les attentes
                    </h3>
                    <div id="attentes-keywords" class="flex flex-wrap gap-3">
                        <!-- Injected via JS -->
                    </div>
                </div>

                <!-- Liste d√©taill√©e par cat√©gorie -->
                <div id="attentes-container" class="space-y-12 pb-20">
                    <!-- Injected via JS -->
                </div>
            </div>
        </div>

        <!-- ONGLET 5: VISION (Restored with Content) -->
        <div id="tab-vision" class="tab-pane absolute inset-0 hidden overflow-auto p-8 bg-[#fdfbf7]">
            <div class="max-w-7xl mx-auto h-full flex flex-col">
                <div class="mb-6 flex-none border-l-4 border-[#549e39] pl-6 py-2">
                    <h2 class="font-oswald text-3xl text-dix-dark uppercase font-normal tracking-wide">Vision Strat√©gique & Prospective</h2>
                    <p class="font-georgia text-dix-dark opacity-60 italic mt-1">Synth√®se des axes prioritaires pour le mandat 2026</p>
                </div>

                <div class="flex-1 grid grid-cols-1 lg:grid-cols-2 gap-8 min-h-0">
                    <!-- COLONNE GAUCHE : RADAR -->
                    <div class="bg-white border border-dix-light/30 shadow-sm p-6 flex flex-col items-center justify-center relative rounded-sm">
                        <h3 class="font-oswald uppercase text-dix-dark text-sm tracking-widest mb-2 w-full text-left flex items-center gap-2">
                            <i data-lucide="radar" class="w-4 h-4 text-[#549e39]"></i>
                            Cartographie des priorit√©s
                        </h3>
                        <div class="w-full h-full max-h-[500px] flex items-center justify-center">
                            <canvas id="expectationsRadar"></canvas>
                        </div>
                    </div>

                    <!-- COLONNE DROITE : SYNTHESE -->
                    <div class="space-y-4 overflow-y-auto pr-2 custom-scrollbar">
                        
                        <!-- Axe 1 -->
                        <div class="bg-white p-5 border-l-4 border-[#549e39] shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start">
                                <h4 class="font-oswald uppercase text-lg text-dix-dark">1. Coordination & Chef de File</h4>
                                <span class="text-xs font-bold text-[#549e39] bg-[#549e39]/10 px-2 py-1 rounded">Priorit√© #1</span>
                            </div>
                            <p class="text-sm font-georgia text-dix-dark opacity-80 mt-2 leading-relaxed">
                                L'attente majeure est un pilotage fort. L'ILOCC doit sortir de son r√¥le d'observateur pour devenir le <strong>chef d'orchestre</strong> op√©rationnel, assurant la coh√©rence entre l'amont (s√©lection, sanitaire) et l'aval (transformation, march√©).
                            </p>
                        </div>

                        <!-- Axe 2 -->
                        <div class="bg-white p-5 border-l-4 border-dix-dark shadow-sm hover:shadow-md transition-shadow">
                            <h4 class="font-oswald uppercase text-lg text-dix-dark">2. Gouvernance Partag√©e</h4>
                            <p class="text-sm font-georgia text-dix-dark opacity-80 mt-2 leading-relaxed">
                                Mise en place d'une prise de d√©cision coll√©giale mais capable d'arbitrages fermes. N√©cessit√© de structurer les coll√®ges pour √©quilibrer les pouvoirs entre producteurs, transformateurs et institutionnels.
                            </p>
                        </div>

                        <!-- Axe 3 -->
                        <div class="bg-white p-5 border-l-4 border-amber-600 shadow-sm hover:shadow-md transition-shadow">
                            <h4 class="font-oswald uppercase text-lg text-dix-dark">3. Observatoire √âconomique</h4>
                            <p class="text-sm font-georgia text-dix-dark opacity-80 mt-2 leading-relaxed">
                                Besoin crucial de transparence sur les donn√©es (volumes, prix, co√ªts de production). L'ILOCC doit devenir le tiers de confiance qui objective la r√©alit√© √©conomique de la fili√®re.
                            </p>
                        </div>

                        <!-- Axe 4 -->
                        <div class="bg-white p-5 border-l-4 border-blue-600 shadow-sm hover:shadow-md transition-shadow">
                            <h4 class="font-oswald uppercase text-lg text-dix-dark">4. D√©fense & Sp√©cificit√©</h4>
                            <p class="text-sm font-georgia text-dix-dark opacity-80 mt-2 leading-relaxed">
                                Protection des races locales et des savoir-faire fermiers. Porter une voix unique aupr√®s des instances nationales (INAO, Minist√®re) pour d√©fendre les d√©rogations et adaptations n√©cessaires √† la Corse.
                            </p>
                        </div>

                        <!-- Axe 5 -->
                        <div class="bg-white p-5 border-l-4 border-purple-600 shadow-sm hover:shadow-md transition-shadow">
                            <h4 class="font-oswald uppercase text-lg text-dix-dark">5. Veille Sanitaire & Qualit√©</h4>
                            <p class="text-sm font-georgia text-dix-dark opacity-80 mt-2 leading-relaxed">
                                Assurer une veille r√©glementaire et sanitaire constante pour anticiper les crises (FCO, etc.) et garantir la qualit√© des produits laitiers corses, socle de la valeur ajout√©e.
                            </p>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- ONGLET 6: ROADMAP (KANBAN) -->
        <div id="tab-roadmap" class="tab-pane absolute inset-0 hidden overflow-hidden p-8 bg-[#fdfbf7]">
            <div class="flex flex-col h-full">
                <div class="mb-4 flex-none border-l-4 border-[#549e39] pl-6 py-2 flex justify-between items-end">
                    <div>
                        <h2 class="font-oswald text-3xl text-dix-dark uppercase font-normal tracking-wide">Feuille de Route</h2>
                        <p class="font-georgia text-dix-dark opacity-60 italic mt-1">Plan d'action op√©rationnel par axe strat√©gique</p>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <div class="flex gap-2">
                            <button onclick="runTour()" id="btn-tuto" class="text-xs bg-amber-100 text-amber-800 px-2 py-1 rounded hover:bg-amber-200 flex items-center gap-1 font-oswald uppercase transition-colors" title="Comment √ßa marche ?">
                                <i data-lucide="wand-2" class="w-3 h-3"></i> Tuto
                            </button>
                            <div id="connection-status" class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded flex items-center gap-1 font-oswald uppercase">
                                <span class="w-2 h-2 rounded-full bg-gray-400"></span> D√©connect√©
                            </div>
                            <button id="btn-export-csv" class="text-xs bg-white border border-gray-300 px-2 py-1 rounded text-dix-dark hover:bg-gray-50 flex items-center gap-1 font-oswald uppercase transition-colors">
                                <i data-lucide="file-spreadsheet" class="w-3 h-3"></i> CSV
                            </button>
                            <button id="btn-export-pdf" class="text-xs bg-dix-dark text-white px-2 py-1 rounded hover:bg-[#2c423e] flex items-center gap-1 font-oswald uppercase transition-colors">
                                <i data-lucide="printer" class="w-3 h-3"></i> Imprimer / PDF
                            </button>
                        </div>
                        <div class="text-[10px] text-gray-400 italic">Donn√©es synchronis√©es</div>
                    </div>
                </div>
                
                <div class="flex-1 min-h-0">
                    <div class="roadmap-container" id="kanban-board">
                        <!-- Kanban Columns injected by JS -->
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- MAIN JAVASCRIPT LOGIC (Legacy) -->
    <script>
        // --- NAVIGATION LOGIC ---
        function switchTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.add('hidden'));
            // Show selected tab
            document.getElementById('tab-' + tabId).classList.remove('hidden');
            
            // Update Nav State
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + tabId).classList.add('active');

            if(tabId === 'vision') setTimeout(initChart, 50);
            if(tabId === 'matrice') renderMatrix();
            if(tabId === 'attentes') renderAttentes();
            // Roadmap render is handled by the module script below
        }

        function selectAndGo(actorId) {
            switchTab('acteurs');
            selectActor(actorId);
        }

        // --- PASSWORD PROTECTION ---
        // V√©rification au chargement de la page
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('ilocc_auth_success') === 'true') {
                document.getElementById('login-overlay').style.display = 'none';
            }
        });

        function checkPassword() {
            const password = document.getElementById('password-input').value;
            const errorMsg = document.getElementById('login-error');
            
            // Mot de passe : ILOCC2026
            if(password === "ILOCC2026") {
                // Enregistrement de la connexion r√©ussie dans le navigateur
                localStorage.setItem('ilocc_auth_success', 'true');
                document.getElementById('login-overlay').style.display = 'none';
            } else {
                errorMsg.style.display = 'block';
            }
        }

        // Allow pressing Enter to login
        document.getElementById('password-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        // --- DATA (ENRICHED WITH CATEGORY FOR ANALYSIS) ---
        const lexiconData = [
            { term: "AOP", def: "Appellation d'Origine Prot√©g√©e. Signe europ√©en garantissant qu'un produit est r√©alis√© selon un savoir-faire reconnu dans une m√™me zone g√©ographique (ex: Brocciu)." },
            { term: "IGP", def: "Indication G√©ographique Prot√©g√©e. Signe identifiant un produit agricole dont la qualit√©, la r√©putation ou d'autres caract√©ristiques sont li√©es √† son origine g√©ographique." },
            { term: "CVO", def: "Cotisation Volontaire Obligatoire. Contribution financi√®re vers√©e par les membres d'une interprofession pour financer des actions communes (communication, R&D, etc.)." },
            { term: "ODG", def: "Organisme de D√©fense et de Gestion. Structure qui r√©dige le cahier des charges d'un signe de qualit√© (AOP/IGP) et s'assure de son respect." },
            { term: "OS", def: "Organisme de S√©lection. Structure agr√©√©e charg√©e de d√©finir et de conduire le programme d'am√©lioration g√©n√©tique d'une race (ici Brebis Corse)." },
            { term: "GDS", def: "Groupement de D√©fense Sanitaire. Association d'√©leveurs d√©di√©e √† l'am√©lioration de la sant√© des troupeaux et la lutte contre les maladies." },
            { term: "FEADER", def: "Fonds Europ√©en Agricole pour le D√©veloppement Rural. Instrument financier de la politique europ√©enne de d√©veloppement rural." },
            { term: "PAC", def: "Politique Agricole Commune. Politique mise en ≈ìuvre par l'Union europ√©enne pour soutenir l'agriculture." },
            { term: "CL", def: "Contr√¥le Laitier. Mesure officielle de la quantit√© et de la qualit√© du lait produit par animal, base de la s√©lection g√©n√©tique." },
            { term: "RZUE", def: "R√®glement Zootechnique de l'Union Europ√©enne. Cadre l√©gal pour la gestion des races et l'√©levage." },
            { term: "CNAOL", def: "Conseil National des Appellations d'Origine Laiti√®res. F√©d√®re les organismes de d√©fense et de gestion des fromages, beurres et cr√®mes AOP." },
            { term: "INAO", def: "Institut National de l'Origine et de la Qualit√©. √âtablissement public fran√ßais charg√© du dispositif des signes officiels d'identification de la qualit√© et de l'origine." },
            { term: "EPIC", def: "√âtablissement Public √† Caract√®re Industriel et Commercial. Statut juridique de l'ODARC." },
            { term: "FAM", def: "FranceAgriMer. √âtablissement national des produits de l'agriculture et de la mer." }
        ];

        const data = [
            {
                id: 1,
                intitule: "I.L.O.C.C ",
                cat: "INTERPROFESSION", // Added category
                objetSocial: "INTERPROFESSION LAITIERE OVINE ET CAPRINE CORSE",
                roleOperationnel: [
                "Change la coordination du plan d‚Äôambition (challenger les partenaires sur les actions inscrites sur 5 ans / signe de qualit√© agneaux / cabris - sanitaire produit fermier)",
                "Animation de fili√®re",
                "Animation de la partie technique (accompagnement sur le terrain des √©leveurs)",
                "Gestion de l‚ÄôAOP Brocciu",
                "Gestion des plans d‚Äôinvestissement - achats group√©s",
                "Promotion / communication / mise en avant du laitier et du produit",
                "Observatoire des prix / laitier",
                "Relations avec le national - action maccro de la fili√®re",
                "Convention avec l‚Äôinstitut d‚Äô√©levage (donn√©es techniques laiti√®res et couts de production / qualit√© du lait avec agrolabs)",
                "Lien avec les autres interprofessions",
                "Action de promotion / repr√©senation - au salon"
                ],
                attentes: [
                "Coordination et gestion de la gouvernance de la fili√®re",
                "√âlaborer la strat√©gie globale d√©finit collectivement / collegiale",
                "D√©l√©gation des sujets aupr√®s des diff√©rents partenaires",
                "Soutient des partenaires dans le cas de prob. / difficult√©s relev√©s",
                "R√¥le dans la communication / promotion des produits",
                "Observatoire des donn√©es collectives (vision macro de la fili√®re) / co√ªt de production",
                "Vision globale sans rentrer dans l‚Äôaction",
                "Action veille sanitaire globale (qualit√© du lait / )",
                "D√©fense de la sp√©cificit√© Corse au niveau des instances nationales",
                "Atteinte des objectifs d√©finit collectivement (dans la strat√©gie globale)"
                ],
                definitions: "",
                liens: "AOP BROCCIU",
                qualite: "",
                membre: false,
                absent: false
            },
            {
                id: 2,
                intitule: "Gruppamente di pastori Corsi (GPC)",
                cat: "REPR√âSENTATION / SYNDICAT",
                objetSocial: "D√©fendre le revenu des √©leveurs et soutenir la valorisation de leur production. Repr√©sentation, promotion et d√©fense d'int√©r√™ts √©conomiques.",
                roleOperationnel: ["ABS (Absent lors de l'atelier)"],
                attentes: ["ABS (Absent lors de l'atelier)"],
                definitions: "",
                liens: "",
                qualite: "",
                membre: true,
                absent: true
            },
            {
                id: 3,
                intitule: "SCA AGNELLU E CAPRETTU DI CORSICA / AREO",
                cat: "TECHNIQUE / COMMERCE",
                objetSocial: "Collecte, vente, abattage, transformation d'ovins et de caprins.",
                roleOperationnel: [
                "Valorisation et le d√©veloppement de la commercialisation des agneaux de lait",
                "IGP agneau de lait corse"
                ],
                attentes: [
                "Chef de file (en t√™te - amener un plan de la fili√®re / par rapport au dossier FAM - chef de file du plan g√©n√©ral)",
                "Coordination avec les autres acteurs de la fili√®re ==> Chef de file gestion dossier IGP",
                "Centraliser les informations de la fili√®re"
                ],
                definitions: "",
                liens: "",
                qualite: "IGP AGNEAU DE LAIT",
                membre: true,
                absent: false
            },
            {
                id: 4,
                intitule: "ASSOCIATION R√âGIONALE DES √âLEVEURS OVINS DE la CORSE (AREO)",
                cat: "TECHNIQUE / COMMERCE",
                objetSocial: "Promotion et organisation de l'√©levage laitier ainsi que de la production, la mise en march√© des produits (agneaux, laine, panse, animaux de r√©forme), la s√©lection et le suivi de la race Corse, la certification des produits, la d√©fense sanitaire du cheptel, l'assistance technique, l'approvisionnement et toute op√©ration destin√©e √† am√©liorer les conditions d'√©levage et de commercialisation des productions.",
                roleOperationnel: [
                "Valorisation et le d√©veloppement de la commercialisation des agneaux de lait",
                "IGP agneau de lait corse",
                "Mise en march√© (No√´l, P√¢ques)",
                "Gestion des coproduits (Laine, panse, animaux de r√©forme)",
                "Approvisionnement (achats group√©s)",
                "Assistance technique et sanitaire (compl√®te l'action GDS/Chambre)"
                ],
                attentes: [
                "Chef de file (en t√™te - amener un plan de la fili√®re / par rapport au dossier FAM - chef de file du plan g√©n√©ral)",
                "Coordination avec les autres acteurs de la fili√®re ==> Chef de file gestion dossier IGP",
                "Centraliser les informations de la fili√®re"
                ],
                definitions: "Porte le label IGP Agneau de lait Corse (Agneu corsu). Organise la vente (No√´l/P√¢ques) et g√®re les coproduits (laine, r√©forme).",
                liens: "NC",
                qualite: "IGP AGNEAU DE LAIT",
                membre: true,
                absent: false
            },
            {
                id: 5,
                intitule: "U CASGILE",
                cat: "PRODUCTEUR / FERMIER",
                objetSocial: "Promotion et d√©fense de la production et des producteurs de fromages fermiers de Corse, elle a pour vocation la d√©fense et la promotion des √©leveurs fermiers install√©s sur le territoire corse qui transforment eux-m√™mes le lait issu de leur propre troupeau, la d√©fense et la promotion des produits des exploitations des √©leveurs fermiers de la Corse, la d√©fense des int√©r√™ts des √©leveurs producteurs fermiers de la Corse au sein de l'Ilocc.",
                roleOperationnel: ["ABS (Absent lors de l'atelier)"],
                attentes: ["ABS (Absent lors de l'atelier)"],
                definitions: "NC",
                liens: "NC",
                qualite: "",
                membre: true,
                absent: true
            },
            {
                id: 6,
                intitule: "CASGIU CASANU",
                cat: "PRODUCTEUR / FERMIER",
                objetSocial: "Promotion et d√©fense de la production et des producteurs de fromages fermiers de Corse (ovins, caprins, bovins) (elle a pour vocation premi√®re de d√©fendre et de promouvoir les fromages fermiers en regroupant tous les √©leveurs qui transforment eux-m√™mes le lait issu de leurs troupeaux qui sont install√©s sur le territoire de Corse).",
                roleOperationnel: [
                "D√©fendre / Promouvoir et structurer le m√©tier de berger / fermier",
                "Assurer la veille sanitaire et r√©glementaire fromagerie - mais en lien avec GDS quand les probl√©matiques viennent de l‚Äô√©levage ==> Intervient sp√©cifiquement pour ses adh√©rents",
                "Les qst sanitaires en fromagerie au coeur de l‚Äôaction // Appui sur la chambre",
                "Faire en sorte que les prod. fermiers soient reconnus comme des v√©ritables pro. (√©conomique)",
                "Promotion et commercialisation des produits fermiers"
                ],
                attentes: [
                "Coordination et f√©d√©ration de l‚Äôensemble des structures autour des √©levages OCC",
                "Pas de vocation techniques ou politiques (Ce n‚Äôest pas un syndicat / ligne politique particuli√®re)",
                "Faire √©merger des probl√©matiques communes",
                "D√©finir des orientations partag√©es",
                "Coordonner la mise en ≈ìuvre d‚Äôactions concr√®tes r√©alis√©es par des acteurs existants",
                "Assurer suivi et coh√©rence",
                "Rassembleur / Coordinateur qui s‚Äôappuie sur les comp√©tences existentes"
                ],
                definitions: "D√©fend le mod√®le 'Fermier' (transforme uniquement son propre lait). G√®re le risque 'Lait Cru' et l'application du paquet hygi√®ne.",
                liens: "GDS",
                qualite: "",
                membre: false,
                absent: false
            },
            {
                id: 7,
                intitule: "OS CORSE (ORGANISME DE SELECTION FRECSOV)",
                cat: "TECHNIQUE / G√âN√âTIQUE",
                objetSocial: "D√©finir les objectifs de s√©lection de la race ovine corse en veillant √† la gestion de la variabilit√© g√©n√©tique et coordonner les actions concourant √† l'am√©lioration g√©n√©tique de la race ovine corse, d√©finir les caract√©ristiques de la race ovine corse et les crit√®res d'appartenance √† cette population, certifier l'appartenance √† la race pure ovine corse et tenir son livre g√©n√©alogique.",
                roleOperationnel: [
                "En charge de la gestion de la race ovine corse",
                "D√©finir des objectifs de s√©lection / mise en place de cette s√©lection",
                "G√©rer la s√©lection / progr√®s attendu / diversit√© g√©n√©tique",
                "Certifier la qualit√© de la race",
                "Promotion de la race (Salons Paris, autre...)",
                "Appui technique sur le contr√¥le de performance, on s‚Äôappuie sur la CA (partenaire sur le progr√®s g√©n√©tique)",
                "En charge du contr√¥le de performances (RZUE), d√©l√©gation √† la CARC et coordination du CL",
                "Orientation g√©n√©tique de la race ovine Corse",
                "Promotion de la race : instances politiques, bergers, grand public",
                "En charge de la reconnaissance raciale des animaux",
                "S√©lection g√©n√©tique modulable en fonction des enjeux, travail au long terme"
                ],
                attentes: [
                "Coordination et f√©d√©ration de l‚Äôensemble des structures autour des √©levages OCC",
                "Mettre en place les orientations strat√©giques de la fili√®re",
                "OS CORSE devrait r√©pondre √† une demande l‚ÄôILOCC",
                "Observatoire des prix de l‚Äôactivit√© / transparence des informations sur toute la fili√®re",
                "Faire √©merger les attentes et les besoins de la fili√®re"
                ],
                definitions: "G√®re le Livre G√©n√©alogique et d√©finit les standards de la race. S'appuie sur le Contr√¥le Laitier (CL) et le RZUE.",
                liens: "CORSIA\nChambre d'agriculture",
                qualite: "",
                membre: false,
                absent: false
            },
            {
                id: 8,
                intitule: "CORSIA (COOP DE SELECTION ET INSEMINATION)",
                cat: "TECHNIQUE / G√âN√âTIQUE",
                objetSocial: "En charge de la commercialisation, la cr√©ation et la diffusion du progr√®s g√©n√©tique via l'ins√©mination et la vente de reproducteurs (b√©liers et agnelles). Application concr√®te de l'orientation d√©cid√©e par l'OS CORSE. Prestation de pension d'agnelles de renouvellement en parall√®le.",
                roleOperationnel: [
                "Vocation Commerciale (ins√©mination, b√©liers reprod. / agnelles de renouvellement) issue du sch√©ma de s√©lection encadr√© par l‚ÄôOS",
                "Appui √† la repro, r√©serve 'sanitaire' en cas de crise",
                "Ins√©minations, reproducteurs, pensions d'agnelles, traitements hormonaux"
                ],
                attentes: [
                "Coordination et f√©d√©ration de l‚Äôensemble des structures autour des √©levages OCC",
                "Mettre en place les orientations strat√©giques de la fili√®re",
                "OS CORSE devrait r√©pondre √† une demande l‚ÄôILOCC",
                "Observatoire des prix de l‚Äôactivit√© / transparence des informations sur toute la fili√®re",
                "Faire √©merger les attentes et les besoins de la fili√®re"
                ],
                definitions: "Bras arm√© de l'OS Corse sur le terrain. R√©alise l'Ins√©mination Artificielle (IA) et vend les reproducteurs s√©lectionn√©s.",
                liens: "OS CORSE",
                qualite: "",
                membre: false,
                absent: false
            },
            {
                id: 9,
                intitule: "L'Association Capraghji Corsi",
                cat: "TECHNIQUE / PRODUCTEUR",
                objetSocial: "protection et promotion de la ch√®vre corse, am√©lioration g√©n√©tique de la race, lutte et pr√©vention sanitaire, promotion et valorisation des produits issus de la ch√®vre corse",
                roleOperationnel: [
                "D√©fense, protection et promotion de la ch√®vre en race Corse",
                "Am√©lioration g√©n√©tique de la race",
                "Lutte et pr√©vention sanitaire, promotion et valorisation des produits issus de l'√©levage caprin en race Corse",
                "Fili√®re caprine, lait et viande",
                "Nous travaillons en collaboration avec les chefs de projet en fili√®re caprine de l'Odarc pour la s√©lection de Bouc (2 chefs de projets en fili√®re caprine). On donne notre avis sur les orientations ph√©no/g√©no ch√®vre corse",
                "Mesure principale: s√©lection de petits boucs √† destination du haras qui se trouve sur la station d'Altiani",
                "IGP Cabri de lait"
                ],
                attentes: [
                "En tant qu‚Äô√©leveur, nous attendons que l‚ÄôILOCC coordonne",
                "Garant de la production et de la qualit√©",
                "L‚ÄôILOCC doit √™tre l‚Äôentit√© qui porte les besoins de la profession et en retour apporte des solutions",
                "Avec l'ilocc, le but est de d√©velopper / p√©rennit√© de la fili√®re caprine",
                "Avoir un lien avec toutes les structures dans le but d'avoir une vision globale de la situation et savoir quels leviers actionner pour conserver, am√©liorer et dynamiser la fili√®re"
                ],
                definitions: "Travaille sur le ph√©notype et g√©notype de la ch√®vre. G√®re la station d'Altiani (p√©pini√®re de boucs). Porte l'IGP Cabri.",
                liens: "ODARC",
                qualite: "IGP CABRI DE LAIT",
                membre: true,
                absent: false
            },
            {
                id: 10,
                intitule: "GDS (FEDERATION DES GROUPEMENTS DE DEFENSE SANITAIRE)",
                cat: "TECHNIQUE / SANITAIRE",
                objetSocial: "Am√©lioration de l'√©tat sanitaire du cheptel en Corse",
                roleOperationnel: [
                "Missions d√©l√©gu√©es par l‚Äô√©tat (prophy. / ...)",
                "Appui technique sanitaire dans les √©levages (multi-fili√®re ovin/caprin, porcin, abeilles / bovins, ...)",
                "Am√©lioration de la sant√© des animaux // collab. avec les v√©to / √©leveurs / acteurs de la fili√®re",
                "Pr√©vention et lutte contre certaines maladies ==> mise en place des dispositifs de prise en charge/ surveillance",
                "Coordination"
                ],
                attentes: [
                "R√¥le de coordination",
                "Chef de file",
                "Faire le lien entre l‚Äôamont / l‚Äôaval",
                "Centralisation des informations / relais des actions de chacun",
                "Convergence des actions de terrain"
                ],
                definitions: "Transversal (ovins, caprins, porcins, etc.). G√®re la prophylaxie (campagnes obligatoires) et les crises (FCO, etc.).",
                liens: "",
                qualite: "",
                membre: false,
                absent: false
            },
            {
                id: 11,
                intitule: "ASSOC. DEFENSE COLLECTEURS-TRANSFORMATEURS",
                cat: "TRANSFORMATION / INDUSTRIE",
                objetSocial: "d√©fense de l'activit√© de transformation fromag√®re de la production corse ovine et caprine",
                roleOperationnel: ["ABS (Absent lors de l'atelier)"],
                attentes: ["ABS (Absent lors de l'atelier)"],
                definitions: "",
                liens: "",
                qualite: "",
                membre: true,
                absent: true
            },
            {
                id: 12,
                intitule: "AOP BROCCIU",
                cat: "QUALIT√â / ODG",
                objetSocial: "Promotion de l'AOP Brocciu et de la fili√®re laiti√®re lors des √©v√®nements nationaux et locaux, interventions aupr√®s des scolaires, promotion sur les r√©seaux sociaux. Gestion de la partie certification gr√¢ce aux contr√¥les. Participation aux √©changes nationaux √† travers le CNAOL (comit√© national des appellations d'origine laiti√®res)",
                roleOperationnel: [
                "ODG (r√©glementaire)",
                "D√©l√©gation des services de l‚Äô√©tat (animation, contr√¥le, suivi)",
                "D√©fense et promotion du Brocciu",
                "Certification des produits / Contr√¥le / Suivi",
                "D√©fense de la race Corse",
                "Information, connaissance des volumes",
                "Coordination avec les services de l‚ÄôETAT / INAO /",
                "√©changes avec le CNAOL et les d√©put√©s sur des sujets tels que le Nutri-Score, le lait cru)"
                ],
                attentes: [
                "Garant de la qualit√© et de la production du lait",
                "Chef de file",
                "Garant des orientations d√©cid√©es collectivement",
                "Observatoire des prix",
                "Soutient de l‚Äôacteur",
                "Assurer la p√©rennit√© de la production de lait en Corse"
                ],
                definitions: "G√®re le cahier des charges AOP. Lien avec l'INAO. D√©fend l'utilisation exclusive des races corses.",
                liens: "",
                qualite: "AOP BROCCIU",
                membre: false,
                absent: false
            },
            {
                id: 13,
                intitule: "CHAMBRE D'AGRICULTURE CORSE",
                cat: "INSTITUTIONNEL / CONSULAIRE",
                objetSocial: "Repr√©sentation politique du monde agricole / La voix des √©leveurs aupr√®s de l‚Äô√©tat/ Corse / UE",
                roleOperationnel: [
                "Repr√©sentation politique du monde agricole",
                "La voix des √©leveurs aupr√®s de l‚Äô√©tat/ Corse / UE",
                "D√©fense de la caract√©risation de l‚Äô√©levage insulaire",
                "D√©veloppement / accompagnement direct aux √©leveurs (dans toutes les dimensions de l‚Äôaccompagnement)",
                "Veille sanitaire (intervenir dans le portage de d√©marche collective)",
                "Mission d√©l√©gu√©e par l‚ÄôOS - contr√¥le laitier officiel",
                "Animation de collectif d‚Äô√©leveurs / cadre territorialis√©",
                "Interface de l‚Äôinterprofession pour faire remonter les besoins sp√©cifiques de la fili√®re aupr√®s des interloc. Corse / Etat / UE"
                ],
                attentes: [
                "Assurer la coor. et la gourvenance de la fili√®re ==> vision commune / voies de convergence vers une vision commune ==> Arbitrer selon les besoins (normes / prix / qualit√©)",
                "dialogue amont / aval",
                "R√¥le √©conomique - assurer le suivi des march√©s / prix / volumes / partage de la valeur ==> soutenir l‚Äôorganisation √©conomique",
                "Structurer les coll√®ges pour chacun soit repr√©sent√© √† ‚Äúforce √©gal‚Äù",
                "Orientations sur quel type de produit / tra√ßabilit√© / qualit√©",
                "Coordonner l‚Äôensemble de la promotion ‚Äúcollective‚Äù",
                "G√©rer les cotisations interpro"
                ],
                definitions: "Instance consulaire. D√©l√©gataire du Contr√¥le Laitier pour l'OS. Accompagne l'installation et les dossiers PAC.",
                liens: "OS",
                qualite: "",
                membre: false,
                absent: false
            },
            {
                id: 14,
                intitule: "ODARC (OFFICE DEVELOP. AGRICOLE RURAL CORSE)",
                cat: "INSTITUTIONNEL / FINANCEUR",
                objetSocial: "EPIC sous tutelle de la Collectivit√© de Corse en charge de la mise en ≈ìuvre de la politique agricole de la Collectivit√© de Corse.Organisme payeur des aides FEADER en Corse.",
                roleOperationnel: [
                "En charge de la mise en oeuvre de la politique agricole de ccorse",
                "D√©l√©gu√© travail de l‚Äôautorit√© de gestion",
                "Deuxi√®me pilier de la PAC",
                "Financement des actions et des op√©rateurs de la fili√®re",
                "Intervient dans le financement de plusieurs plans et dossiers (sanitaire / technique, ...)",
                "Appui technique et sanitaire aussi en tant que coop√©rateur",
                "R&D ‚ü∂ analyse dans nos labo pour les IGP ag/cab, sur les casgu / fili√®re lait / brebis",
                "Gestion foncier ‚ü∂ pour r√©cup√©rer du foncier √† mettre √† disposition des √©leveurs",
                "Formation et transmission (contrat de coop√©ration / accueil de futures jeunes √©leveurs avant leur installation) / Fromagerie",
                "Commercialisation - appui financier au montage de projet dans le cadre de d√©marches collectives",
                "Promotion : Mise en place de campagne de promotion / label resto qui met en avant les structures qui d‚Äôapprovisionnement locaux / Salon de l‚Äôagriculture et not. le fromage",
                "Participation au financement des op√©rateurs de la fili√®re (plan ambition avec FAM, plan capra sana, plan tremblante, FCO, etc.)",
                "Financement des dossiers de modernisation des exploitations agricoles",
                "Mise en place et financement des CCPA",
                "Assure en partenariat avec l'association Capraghi corsi les missions en lien avec le sch√©ma de s√©lection de la race caprine corse"
                ],
                attentes: [
                "D√©finition des enjeux collectifs",
                "Gouvernance ‚ü∂ imposer des choix de trajectoire aupr√®s de l‚Äôensemble des membres du coll√®ge",
                "Coordination des actions des acteurs de la fili√®re au service de la trajectoire d√©finit par l‚ÄôILOCC",
                "Chef de file des projets de la fili√®re (retenu dans le cadre des actions financ√©es par l‚ÄôODARC)",
                "Elaboration des donn√©es de la fili√®re",
                "Mettre en place la CVO (r√©allocation)"
                ],
                definitions: "Bras arm√© de la Collectivit√© de Corse. Financeur majeur (installations, √©quipements, plans sanitaires).",
                liens: "AOP BROCCIU, Association Capraghji, AREO",
                qualite: "",
                membre: false,
                absent: false
            },
            {
                id: 15,
                intitule: "FRANCEAGRIMER",
                cat: "INSTITUTIONNEL / TUTELLE",
                objetSocial: "Administration publique (tutelle) des activit√©s √©conomiques",
                roleOperationnel: [
                "Financement du fonctionnement de l'interprofession et notamment son r√¥le de coordination et chef de file de la fili√®re",
                "Financement des actions de structuration des fili√®res",
                "Financement des actions de promotion dans le cadre des dispositifs nationaux et europ√©ens",
                "Financement appui technique et plan sanitaire aupr√®s des structures concern√©es",
                "Financement des actions de RD notamment dans le cadre du sch√©ma de s√©lection port√© par l'OS & la Corsia",
                "Appui au d√©veloppement de projets de fili√®res"
                ],
                attentes: [
                "ABS"
                ],
                definitions: "R√©gulateur et financeur national. Surveille les march√©s et intervient en cas de crise.",
                liens: "OS, CORSIA",
                qualite: "",
                membre: false,
                absent: false
            }
        ];

        // --- MATRIX DATA (CORRECTED BASED ON CSV) ---
        const matrixData = [
            { id: 1, rep: "Interprofession / National", gov: "Coordination fili√®re", tech: "Animation technique", sani: "Gestion AOP Brocciu", eco: "Observatoire prix / Promo" },
            { id: 2, rep: "D√©fense int√©r√™ts √©co", gov: "-", tech: "-", sani: "-", eco: "Revenu √©leveurs" },
            { id: 3, rep: "-", gov: "-", tech: "Collecte / Abattage", sani: "IGP Agneau", eco: "Commercialisation / Valo" },
            { id: 4, rep: "-", gov: "-", tech: "Assistance technique / Appro", sani: "IGP Agneau / Sanitaire", eco: "Mise en march√© / Coproduits" },
            { id: 5, rep: "Producteurs Fermiers", gov: "-", tech: "-", sani: "-", eco: "Promotion fermi√®re" },
            { id: 6, rep: "M√©tier Berger/Fermier", gov: "-", tech: "-", sani: "Veille Sanitaire & R√©glem.", eco: "Promo Circuits Courts" },
            { id: 7, rep: "Promotion Race", gov: "Objectifs S√©lection", tech: "G√©n√©tique / Contr√¥le Perf", sani: "Certification Race", eco: "-" },
            { id: 8, rep: "-", gov: "-", tech: "Ins√©mination (IA) / Repro", sani: "R√©serve Sanitaire", eco: "Vente Reproducteurs" },
            { id: 9, rep: "D√©fense Ch√®vre Corse", gov: "-", tech: "S√©lection / Boucs", sani: "Lutte Sani / IGP Cabri", eco: "Fili√®re Lait & Viande" },
            { id: 10, rep: "-", gov: "Coordination Sanitaire", tech: "Appui √âlevage", sani: "Prophylaxie / Crises", eco: "-" },
            { id: 11, rep: "Transformateurs", gov: "-", tech: "-", sani: "-", eco: "D√©fense Activit√©" },
            { id: 12, rep: "D√©fense AOP", gov: "ODG (Cahier des charges)", tech: "Contr√¥les", sani: "Certification / Race", eco: "Volumes / Promo" },
            { id: 13, rep: "Politique / Voix √âleveurs", gov: "-", tech: "Dvt / Contr√¥le Laitier", sani: "Veille Terrain", eco: "-" },
            { id: 14, rep: "Politique CdC", gov: "Autorit√© Gestion", tech: "R&D / Foncier / Formation", sani: "Labo / Appui", eco: "Financement (PAC) / Promo" },
            { id: 15, rep: "Tutelle √âtat", gov: "-", tech: "Financement R&D", sani: "Financement Plans", eco: "Financement Structuration" }
        ];

        // --- INTERACTION LOGIC ---
        function highlightInterproMembers() {
            document.querySelectorAll('.node-base').forEach(node => {
                if (node.id === 'hub-ilocc') return;
                if (node.classList.contains('is-interpro-member')) {
                    node.classList.add('is-member-highlight');
                } else {
                    node.classList.add('not-member-dimmed');
                }
            });
        }

        function clearMemberHighlight() {
            document.querySelectorAll('.node-base').forEach(node => {
                node.classList.remove('is-member-highlight', 'not-member-dimmed');
            });
        }

        // --- RENDER FUNCTIONS ---
        // 1. Acteurs (D.I.X.)
        let selectedId = 1;
        let searchTerm = "";
        let filterMember = false;

        // Init Lucide icons
        lucide.createIcons();

        function renderLexicon() {
            const container = document.getElementById('lexicon-content');
            container.innerHTML = lexiconData.sort((a,b) => a.term.localeCompare(b.term)).map(item => `
                <div class="pb-4 border-b border-[#f3f3f3] last:border-0 last:pb-0">
                    <span class="font-oswald uppercase font-normal text-dix-dark block mb-1 tracking-wide">${item.term}</span>
                    <p class="text-sm text-dix-dark leading-relaxed opacity-90">${item.def}</p>
                </div>
            `).join('');
        }

        function toggleLexicon(show) {
            const modal = document.getElementById('lexicon-modal');
            if (show) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            } else {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        function renderList() {
            const listContainer = document.getElementById('actor-list');
            const filteredData = data.filter(actor => {
                const matchesSearch = actor.intitule.toLowerCase().includes(searchTerm.toLowerCase());
                const matchesMember = filterMember ? actor.membre : true;
                return matchesSearch && matchesMember;
            });

            if (filteredData.length === 0) {
                listContainer.innerHTML = `
                    <div class="p-8 text-center text-dix-dark opacity-40 text-sm italic font-georgia">
                        Aucune structure trouv√©e.
                    </div>
                `;
                return;
            }

            listContainer.innerHTML = filteredData.map(actor => {
                const isActive = selectedId === actor.id;
                const activeClass = isActive 
                    ? 'bg-[#f3f3f3] border-l-4 border-dix-dark text-dix-dark' 
                    : 'hover:bg-[#f3f3f3]/50 border-l-4 border-transparent text-dix-dark opacity-80';
                
                return `
                    <button 
                        onclick="selectActor(${actor.id})"
                        class="w-full text-left p-4 transition-all duration-200 flex items-center justify-between group ${activeClass}"
                    >
                        <div class="overflow-hidden">
                            <div class="font-oswald uppercase text-sm truncate font-normal tracking-wide">${actor.intitule}</div>
                            ${actor.qualite ? `
                                <span class="text-xs text-[#549e39] font-georgia italic font-medium inline-flex items-center gap-1 mt-1 truncate">
                                    <i data-lucide="award" class="w-3 h-3 flex-shrink-0"></i> ${actor.qualite}
                                </span>
                            ` : ''}
                        </div>
                        ${actor.absent ? `
                            <span class="ml-2 text-[10px] text-dix-dark opacity-50 px-2 py-0.5 border border-dix-dark/20 uppercase font-oswald tracking-wider flex-shrink-0">ABS</span>
                        ` : ''}
                    </button>
                `;
            }).join('');
            
            lucide.createIcons();
        }

        function renderMain() {
            const mainContainer = document.getElementById('main-content');
            const actor = data.find(d => d.id === selectedId);

            if (!actor) return;

            // HTML Strings for Sections
            const headerHtml = `
                <div class="max-w-4xl mx-auto space-y-8">
                    <div class="bg-white p-8 shadow-sm border-l-4 border-[#549e39] relative overflow-hidden">
                        <div class="flex justify-between items-start relative z-10">
                            <div class="w-full">
                                <h2 class="text-3xl font-oswald uppercase font-normal text-dix-dark mb-3 leading-tight tracking-wide">${actor.intitule}</h2>
                                <div class="flex flex-wrap gap-3 mt-4">
                                    ${actor.membre ? `
                                        <span class="inline-flex items-center gap-1.5 px-3 py-1 bg-[#549e39] text-[#f3f3f3] text-xs font-oswald uppercase tracking-wider">
                                            <i data-lucide="check-circle" class="w-3.5 h-3.5"></i> Membre ILOCC
                                        </span>
                                    ` : `
                                        <span class="inline-flex items-center gap-1.5 px-3 py-1 bg-[#f3f3f3] text-dix-dark opacity-50 text-xs font-oswald uppercase tracking-wider border border-dix-dark/10">
                                            Pas membre ILOCC
                                        </span>
                                    `}
                                    
                                    ${actor.qualite ? `
                                        <span class="inline-flex items-center gap-1.5 px-3 py-1 bg-dix-dark text-[#f3f3f3] text-xs font-oswald uppercase tracking-wider">
                                            <i data-lucide="award" class="w-3.5 h-3.5"></i> ${actor.qualite}
                                        </span>
                                    ` : ''}

                                    ${actor.absent ? `
                                        <span class="inline-flex items-center gap-1.5 px-3 py-1 border border-dix-dark/20 text-dix-dark opacity-60 text-xs font-oswald uppercase tracking-wider">
                                            <i data-lucide="x-circle" class="w-3.5 h-3.5"></i> Absent √† l'atelier
                                        </span>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- BLOC 1: OFFICIEL -->
                    <div class="bg-white shadow-sm flex flex-col border border-dix-dark/10">
                        <div class="p-4 border-b border-dix-dark/10 bg-[#f3f3f3] flex items-center gap-2">
                            <i data-lucide="book-open" class="w-5 h-5 text-dix-dark"></i>
                            <h3 class="font-oswald uppercase font-normal text-dix-dark tracking-wide">Mission Officielle (Statuts)</h3>
                        </div>
                        <div class="p-8 flex-1 flex flex-col gap-6">
                            <div>
                                <p class="text-dix-dark text-base leading-relaxed font-georgia border-l-2 border-[#549e39] pl-4 italic">
                                    "${actor.objetSocial || "Information non disponible"}"
                                </p>
                            </div>
                            
                            ${(actor.definitions || (actor.liens && actor.liens !== "NC")) ? `
                                <div class="pt-6 border-t border-dix-dark/10">
                                    <h4 class="text-xs font-oswald text-[#549e39] uppercase tracking-widest mb-4 flex items-center gap-2">
                                        <i data-lucide="info" class="w-3 h-3"></i> Contexte & Ecosyst√®me
                                    </h4>
                                    
                                    ${actor.definitions ? `
                                        <div class="mb-4">
                                            <p class="text-sm text-dix-dark opacity-80 leading-relaxed font-georgia whitespace-pre-line">
                                                ${actor.definitions}
                                            </p>
                                        </div>
                                    ` : ''}

                                    ${(actor.liens && actor.liens !== "NC") ? `
                                        <div class="flex items-start gap-3 bg-[#f3f3f3] p-4 border-l-2 border-dix-dark">
                                            <i data-lucide="network" class="w-4 h-4 text-[#549e39] mt-1 flex-shrink-0"></i>
                                            <div>
                                                <span class="text-xs font-oswald uppercase text-dix-dark block mb-1 tracking-wide">Liens & Collaborations</span>
                                                <span class="text-sm text-dix-dark font-georgia block italic">
                                                    ${actor.liens.replace(/\n/g, ', ')}
                                                </span>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- BLOC 2: OPERATIONNEL -->
                    <div class="bg-white shadow-sm flex flex-col relative overflow-hidden border border-[#549e39]/20">
                        <div class="absolute top-0 left-0 w-1.5 h-full bg-[#549e39]"></div>
                        <div class="p-4 border-b border-[#549e39]/10 bg-[#549e39]/10 flex items-center gap-2">
                            <i data-lucide="file-text" class="w-5 h-5 text-[#549e39]"></i>
                            <h3 class="font-oswald uppercase font-normal text-dix-dark tracking-wide">R√¥le Op√©rationnel (V√©cu terrain)</h3>
                        </div>
                        <div class="p-8 flex-1">
                            ${actor.absent ? `
                                <div class="flex flex-col items-center justify-center text-dix-dark opacity-40 text-sm text-center py-6">
                                    <i data-lucide="x-circle" class="w-10 h-10 mb-3 opacity-30"></i>
                                    <p class="font-georgia italic">Pas de remont√©e terrain directe.</p>
                                    <p class="text-xs opacity-70 mt-1 font-oswald uppercase">(Acteur absent lors de l'atelier)</p>
                                </div>
                            ` : `
                                <ul class="space-y-4">
                                    ${actor.roleOperationnel.map(item => `
                                        <li class="flex items-start gap-4 text-base text-dix-dark font-georgia">
                                            <span class="mt-2 w-1.5 h-1.5 bg-[#549e39] flex-shrink-0"></span>
                                            <span class="leading-relaxed">${item}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            `}
                        </div>
                    </div>

                    <!-- BLOC 3: ATTENTES -->
                    <div class="bg-dix-dark text-[#f3f3f3] p-8 shadow-md border-t-4 border-[#549e39]">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="p-2 bg-[#549e39] text-[#f3f3f3]">
                                <i data-lucide="target" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <h3 class="font-oswald uppercase font-normal text-xl tracking-wide">Attentes vis-√†-vis de l'ILOCC</h3>
                                <p class="text-xs text-[#f3f3f3] opacity-60 font-georgia italic mt-1">Demandes politiques exprim√©es lors de l'atelier</p>
                            </div>
                        </div>

                        ${(actor.attentes.length === 1 && actor.attentes[0].includes("ABS")) ? `
                            <p class="text-sm text-[#f3f3f3] opacity-40 italic pl-2 font-georgia">Aucune attente exprim√©e (Structure absente).</p>
                        ` : `
                            <div class="grid grid-cols-1 gap-4">
                                ${actor.attentes.map(item => `
                                    <div class="bg-[#f3f3f3]/5 p-4 border border-[#f3f3f3]/10 flex items-start gap-4 hover:bg-[#f3f3f3]/10 transition-colors">
                                        <i data-lucide="message-square" class="w-4 h-4 text-[#549e39] mt-1 flex-shrink-0"></i>
                                        <span class="text-sm text-[#f3f3f3] font-georgia leading-relaxed">${item}</span>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            mainContainer.innerHTML = headerHtml;
            lucide.createIcons();
        }

        function selectActor(id) {
            selectedId = id;
            renderList(); // Re-render list to update active state
            renderMain();
        }

        // 2. Matrix
        function renderMatrix() {
            const body = document.getElementById('matrix-body');
            if(!body) return;
            body.innerHTML = matrixData.map(a => `
                <tr>
                    <td class="font-oswald uppercase text-xs font-medium">${data.find(d=>d.id===a.id).intitule}</td>
                    <td>${a.rep}</td>
                    <td>${a.gov}</td>
                    <td>${a.tech}</td>
                    <td>${a.sani}</td>
                    <td>${a.eco}</td>
                </tr>
            `).join('');
        }

        // 3. Vision Chart
        let radarChart = null;
        function initChart() {
            const canvas = document.getElementById('expectationsRadar');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (radarChart) radarChart.destroy();
            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: [ 'Coordination', 'Gouvernance', 'Observatoire', 'D√©fense Sp√©cificit√©', 'Veille Qualit√©', 'Promotion' ],
                    datasets: [{
                        label: 'Intensit√© de la demande',
                        data: [10, 9, 8, 9, 7, 8],
                        backgroundColor: 'rgba(180, 83, 9, 0.2)', // Amber-like
                        borderColor: '#B45309',
                        pointBackgroundColor: '#B45309',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        r: { suggestedMin: 0, suggestedMax: 10, ticks: { display: false },
                            angleLines: { color: '#E5E7EB' }, grid: { color: '#E5E7EB' },
                            pointLabels: { font: { size: 10, weight: '700', family: 'Oswald' }, color: '#4B5563' }
                        } 
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // 4. Render Attentes
        function renderAttentes() {
            const keywordsContainer = document.getElementById('attentes-keywords');
            const mainContainer = document.getElementById('attentes-container');
            
            if (!keywordsContainer || !mainContainer) return;

            const stopWords = ['de', 'la', 'le', 'et', 'les', 'des', 'en', 'un', 'une', 'pour', 'dans', 'sur', 'au', 'aux', 'avec', 'par', 'ce', 'se', 'que', 'qui', 'ne', 'pas', 'du', 'a', '√†', 'est', 'sont'];
            let wordCount = {};
            
            data.forEach(actor => {
                if (actor.attentes && !actor.attentes[0].includes("ABS")) {
                    actor.attentes.forEach(text => {
                        const words = text.toLowerCase().replace(/[.,/#!$%^&*;:{}=_`~()]/g,"").split(/\s+/);
                        words.forEach(w => {
                            if (w.length > 3 && !stopWords.includes(w)) {
                                wordCount[w] = (wordCount[w] || 0) + 1;
                            }
                        });
                    });
                }
            });
            
            const concepts = [
                { term: "COORDINATION", count: 12 },
                { term: "GOUVERNANCE", count: 9 },
                { term: "OBSERVATOIRE / DONN√âES", count: 8 },
                { term: "CHEF DE FILE", count: 7 },
                { term: "STRAT√âGIE", count: 6 },
                { term: "PROMOTION", count: 5 },
                { term: "SANITAIRE", count: 4 },
                { term: "D√âFENSE SP√âCIFICIT√â", count: 4 }
            ];

            keywordsContainer.innerHTML = concepts.map(c => `
                <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-[#f3f3f3] text-dix-dark text-xs font-oswald uppercase tracking-wide border border-dix-dark/10 rounded-full">
                    ${c.term} <span class="bg-[#549e39] text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full min-w-[20px] text-center">${c.count}</span>
                </span>
            `).join('');

            const categories = {};
            data.forEach(actor => {
                const cat = actor.cat || "AUTRE";
                if (!categories[cat]) categories[cat] = [];
                categories[cat].push(actor);
            });

            const summaries = {
                "INTERPROFESSION": "R√¥le de chef de file pour la strat√©gie globale, la coordination et la d√©fense des sp√©cificit√©s.",
                "REPR√âSENTATION / SYNDICAT": "D√©fense du revenu et des int√©r√™ts √©conomiques des √©leveurs.",
                "TECHNIQUE / COMMERCE": "Coordination forte et centralisation de l'information (r√¥le de chef de file).",
                "PRODUCTEUR / FERMIER": "Besoin de f√©d√©ration et de coh√©rence globale, sans ing√©rence dans l'op√©rationnel.",
                "TECHNIQUE / G√âN√âTIQUE": "Attente d'orientations strat√©giques claires pour aligner la s√©lection et besoin de transparence.",
                "TECHNIQUE / PRODUCTEUR": "Coordination globale pour p√©renniser la fili√®re et garantir la qualit√©.",
                "TECHNIQUE / SANITAIRE": "R√¥le de coordination et de centralisation des informations sanitaires.",
                "TRANSFORMATION / INDUSTRIE": "D√©fense des int√©r√™ts des transformateurs.",
                "QUALIT√â / ODG": "Garantie des orientations collectives, de la qualit√© et suivi √©conomique (observatoire).",
                "INSTITUTIONNEL / CONSULAIRE": "Gouvernance partag√©e, arbitrage et coordination de la promotion collective.",
                "INSTITUTIONNEL / FINANCEUR": "Gouvernance capable d'imposer des choix de trajectoire et de coordonner les actions.",
                "INSTITUTIONNEL / TUTELLE": "Accompagnement et structuration."
            };

            mainContainer.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    ${Object.keys(categories).map(cat => `
                        <div class="space-y-4">
                            <div class="border-b border-[#549e39]/30 pb-2 mb-4">
                                <h3 class="font-oswald text-xl text-[#549e39]">${cat}</h3>
                                ${summaries[cat] ? `<p class="text-sm text-dix-dark opacity-70 font-georgia mt-1 italic">"${summaries[cat]}"</p>` : ''}
                            </div>
                            <div class="grid gap-6">
                                ${categories[cat].map(actor => {
                                    const isAbs = actor.attentes[0].includes("ABS");
                                    return `
                                        <div class="bg-white rounded p-6 shadow-sm border border-dix-dark/10 flex flex-col h-full ${isAbs ? 'opacity-60 bg-gray-50' : ''}">
                                            <div class="flex items-start justify-between mb-4 border-b border-gray-100 pb-2">
                                                <h4 class="font-oswald uppercase text-dix-dark text-sm font-medium leading-snug pr-2">${actor.intitule}</h4>
                                                ${isAbs ? '<span class="text-[10px] font-oswald text-gray-400 border border-gray-200 px-1 rounded">ABS</span>' : ''}
                                            </div>
                                            <div class="flex-1">
                                                ${isAbs ? 
                                                    '<p class="text-xs text-gray-400 italic font-georgia">Aucune attente exprim√©e (Absent).</p>' : 
                                                    `<ul class="space-y-2">
                                                        ${actor.attentes.map(a => `
                                                            <li class="flex items-start gap-2 text-xs text-dix-dark/80 font-georgia leading-relaxed">
                                                                <span class="mt-1.5 w-1 h-1 bg-[#549e39] rounded-full flex-shrink-0"></span>
                                                                <span>${a}</span>
                                                            </li>
                                                        `).join('')}
                                                    </ul>`
                                                }
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            lucide.createIcons();
        }

        // Listeners
        document.getElementById('search-input').addEventListener('input', (e) => {
            searchTerm = e.target.value;
            renderList();
        });

        document.getElementById('filter-member').addEventListener('change', (e) => {
            filterMember = e.target.checked;
            renderList();
        });

        // Initialize
        renderLexicon();
        renderList();
        renderMain();

    </script>

    <!-- FIREBASE & KANBAN MODULE -->
    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, doc, deleteDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- CONFIGURATION FIREBASE ---
        // Configuration manuelle forc√©e (Celle que vous avez fournie)
        const manualConfig = {
            apiKey: "AIzaSyDZkwWnd2llryuaYpeNppXEqjlbk11GvrE",
            authDomain: "ilocc-1b57d.firebaseapp.com",
            projectId: "ilocc-1b57d",
            storageBucket: "ilocc-1b57d.firebasestorage.app",
            messagingSenderId: "653444870972",
            appId: "1:653444870972:web:6942083028df18b2cea439"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ilocc-preview';
        
        let db;
        let auth;
        let user;
        let lastError = null; // Stocke la derni√®re erreur pour diagnostic

        const updateConnectionStatus = (isConnected, errorMsg = null) => {
            const statusEl = document.getElementById('connection-status');
            if (statusEl) {
                if (isConnected) {
                    statusEl.innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500"></span> Connect√©`;
                    statusEl.className = `text-xs px-2 py-1 rounded flex items-center gap-1 font-oswald uppercase bg-green-100 text-green-700 cursor-default`;
                    statusEl.onclick = null;
                } else {
                    statusEl.innerHTML = `<span class="w-2 h-2 rounded-full bg-red-500"></span> D√©connect√© (?)`;
                    statusEl.className = `text-xs px-2 py-1 rounded flex items-center gap-1 font-oswald uppercase bg-red-100 text-red-700 cursor-pointer hover:bg-red-200`;
                    statusEl.title = "Cliquez pour voir l'erreur";
                    // Click pour voir l'erreur
                    statusEl.onclick = () => {
                        let alertText = "Statut : D√©connect√©.\n\n";
                        if (errorMsg) {
                            alertText += "Erreur technique : " + errorMsg + "\n\n";
                            if (errorMsg.includes("auth/operation-not-allowed")) {
                                alertText += "üëâ SOLUTION : Activez l'authentification 'Anonyme' dans la console Firebase (Authentication > Sign-in method).";
                            } else if (errorMsg.includes("permission-denied")) {
                                alertText += "üëâ SOLUTION : V√©rifiez les R√®gles de s√©curit√© dans Firestore Database.";
                            }
                        } else {
                            alertText += "V√©rifiez votre connexion internet ou la configuration Firebase.";
                        }
                        alert(alertText);
                    };
                }
            }
        };

        // Initialisation robuste
        try {
            let app;
            // On v√©rifie si une app existe d√©j√† pour √©viter les doublons
            if (getApps().length === 0) {
                app = initializeApp(manualConfig);
            } else {
                app = getApp();
            }

            // Initialisation des services avec l'instance 'app' explicite
            db = getFirestore(app);
            auth = getAuth(app);

            // Logique d'authentification
            const initAuth = async () => {
                try {
                    // On force la connexion anonyme avec cette config sp√©cifique
                    await signInAnonymously(auth);
                } catch (e) {
                    lastError = e.code || e.message;
                    console.error("Erreur Auth:", e);
                    updateConnectionStatus(false, lastError);
                }
            };
            
            initAuth();

            onAuthStateChanged(auth, (u) => {
                user = u;
                if (user) {
                    console.log("Connect√© √† Firebase avec succ√®s (UID: " + user.uid + ")");
                    updateConnectionStatus(true);
                    subscribeToRoadmap();
                } else {
                    // Si on n'est pas connect√© et qu'il n'y a pas d'erreur explicite encore
                    if (!lastError) updateConnectionStatus(false, "En attente de connexion...");
                }
            });

        } catch (err) {
            console.error("Erreur d'initialisation Firebase globale:", err);
            lastError = err.message;
            updateConnectionStatus(false, err.message);
        }


        // --- KANBAN LOGIC ---
        const axes = [
            { id: 1, title: "Coordination & Chef de File" },
            { id: 2, title: "Gouvernance Partag√©e" },
            { id: 3, title: "Observatoire √âconomique" },
            { id: 4, title: "D√©fense & Sp√©cificit√©" },
            { id: 5, title: "Veille Sanitaire & Qualit√©" }
        ];

        let roadmapData = [];

        function subscribeToRoadmap() {
            if (!db || !user) return;
            // Public path as per instructions: /artifacts/{appId}/public/data/roadmap
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'roadmap'));
            
            onSnapshot(q, (snapshot) => {
                roadmapData = [];
                snapshot.forEach((doc) => {
                    roadmapData.push({ id: doc.id, ...doc.data() });
                });
                renderKanban(roadmapData);
            }, (error) => {
                console.error("Error fetching roadmap:", error);
            });
        }

        function renderKanban(items) {
            const board = document.getElementById('kanban-board');
            if (!board) return;

            board.innerHTML = axes.map(axis => {
                // Si items est vide, on affiche juste la structure (√©vite √©cran blanc au chargement)
                const axisObjs = items ? items.filter(i => parseInt(i.axisId) === axis.id && i.type === 'Objectif') : [];
                
                return `
                    <div class="roadmap-col">
                        <div class="roadmap-header">
                            <span>${axis.title}</span>
                            <span class="text-xs opacity-70 bg-white/20 px-2 rounded">${axisObjs.length}</span>
                        </div>
                        <div class="roadmap-body">
                            ${axisObjs.length === 0 && (!items || items.length === 0) ? '<div class="text-xs text-gray-400 text-center italic py-4">Aucun objectif</div>' : ''}
                            ${axisObjs.map(obj => {
                                const linkedActions = items.filter(i => i.parentId === obj.id);
                                return `
                                <div class="roadmap-card group relative" onclick="openDetails('${obj.id}')">
                                    <div class="flex justify-between items-start mb-1">
                                        <span class="text-[10px] font-oswald uppercase tracking-wider text-dix-light">OBJECTIF</span>
                                        ${(user) ? `<button class="delete-btn opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500" data-id="${obj.id}">√ó</button>` : ''}
                                    </div>
                                    <h4 class="font-bold text-dix-dark text-sm leading-tight mb-2 font-oswald">${obj.title}</h4>
                                    <p class="text-xs text-gray-600 mb-2 font-georgia line-clamp-3">${obj.desc || ''}</p>
                                    
                                    <!-- Embedded Actions List -->
                                    ${linkedActions.length > 0 ? `
                                        <div class="mt-2 pt-2 border-t border-gray-100">
                                            <span class="text-[9px] font-oswald uppercase text-gray-400 block mb-1">Actions :</span>
                                            ${linkedActions.map(act => `
                                                <div class="action-item-mini">
                                                    <i data-lucide="wrench" class="w-3 h-3 text-amber-500 flex-shrink-0 mt-0.5"></i>
                                                    <span class="line-clamp-1">${act.title}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}

                                    <div class="flex justify-between items-end mt-2">
                                        <!-- INDICATEUR AJOUTER ACTION -->
                                         <div class="text-[10px] text-dix-light font-oswald uppercase tracking-wider flex items-center gap-1 opacity-60 group-hover:opacity-100 transition-opacity">
                                            <i data-lucide="plus-circle" class="w-3 h-3"></i> Action / Note
                                        </div>

                                        ${(obj.notes && obj.notes.length > 0) ? `<div class="text-[9px] text-blue-600 flex items-center gap-1"><i data-lucide="message-circle" class="w-3 h-3"></i> ${obj.notes.length} note(s)</div>` : ''}
                                    </div>
                                </div>
                            `}).join('')}
                            
                            <div class="add-card-btn" data-axis="${axis.id}" data-axisname="${axis.title}">
                                + Ajouter un Objectif
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Init Icons for injected HTML
            if (typeof lucide !== 'undefined') lucide.createIcons();
            
            // Re-attach handlers because innerHTML rewrite destroys them
            attachEventHandlers();
        }

        function attachEventHandlers() {
            const board = document.getElementById('kanban-board');
            if (!board) return;

            // Add Event Listeners for "Add" buttons
            board.querySelectorAll('.add-card-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (!db) { alert("Connexion base de donn√©es en cours ou √©chou√©e..."); return; }
                    openModal(e.target.dataset.axis, e.target.dataset.axisname);
                });
            });

            // Add Event Listeners for "Delete" buttons
            board.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    if(confirm("Supprimer cet objectif et ses actions ?")) {
                        deleteItem(e.target.dataset.id);
                    }
                });
            });
        }
        
        // Initial empty render to avoid blank screen while loading
        renderKanban([]);


        // --- DETAILS & NOTES LOGIC ---
        let currentDetailId = null;
        const detailsModal = document.getElementById('details-modal');
        const detailsContent = document.getElementById('details-content');
        const notesList = document.getElementById('notes-list');
        const actionsList = document.getElementById('actions-list');
        const btnAddNote = document.getElementById('btn-add-note');
        const btnAddAction = document.getElementById('btn-add-action');

        // Expose to window for onclick in HTML
        window.openDetails = function(id) {
            currentDetailId = id;
            const item = roadmapData.find(i => i.id === id);
            if (!item) return;

            const axisTitle = axes.find(a => a.id === item.axisId)?.title || "Inconnu";

            // Render Static Content (Objective)
            detailsContent.innerHTML = `
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-xs font-oswald uppercase tracking-wider px-2 py-1 rounded bg-gray-100 text-gray-600">${axisTitle}</span>
                    <span class="text-xs font-oswald uppercase tracking-wider px-2 py-1 rounded bg-green-100 text-green-800">Objectif Strat√©gique</span>
                </div>
                <h2 class="text-2xl font-oswald text-dix-dark mb-4">${item.title}</h2>
                
                <div>
                    <span class="block text-[10px] font-oswald uppercase text-gray-400 mb-2">Description & Indicateurs</span>
                    <p class="text-sm font-georgia text-dix-dark leading-relaxed whitespace-pre-wrap">${item.desc || 'Pas de description d√©taill√©e.'}</p>
                </div>
            `;

            // Filter Actions linked to this objective
            const linkedActions = roadmapData.filter(i => i.parentId === id);
            renderActionsList(linkedActions);

            // Render Notes
            renderNotesList(item.notes || []);

            detailsModal.style.display = 'flex';
        }

        window.closeDetailsModal = function() {
            detailsModal.style.display = 'none';
            currentDetailId = null;
        }
        
        // --- TUTORIAL LOGIC ---
        window.runTour = function() {
            const steps = [
                {
                    target: null, // Center screen
                    title: "Bienvenue sur la Feuille de Route",
                    text: "Cet outil collaboratif vous permet de d√©finir ensemble les objectifs strat√©giques et les actions op√©rationnelles de l'ILOCC pour 2026."
                },
                {
                    target: '.roadmap-col:first-child', // First Column
                    title: "Les Axes Strat√©giques",
                    text: "La feuille de route est organis√©e en 5 colonnes correspondant aux 5 axes majeurs de la vision."
                },
                {
                    target: '.add-card-btn', // Add Button
                    title: "Ajouter un Objectif",
                    text: "Cliquez sur ce bouton en bas de chaque colonne pour cr√©er un nouvel objectif strat√©gique (le 'Quoi')."
                },
                {
                    target: '.roadmap-card', // A Card (if exists) or fallback
                    fallbackTarget: '.add-card-btn', 
                    title: "D√©tails & Actions",
                    text: "Cliquez sur une carte existante pour ouvrir sa fiche d√©taill√©e. C'est l√† que vous pourrez ajouter des ACTIONS concr√®tes (le 'Comment') et des notes."
                },
                {
                    target: '#btn-export-pdf', // Export buttons
                    title: "Exporter",
                    text: "√Ä tout moment, vous pouvez exporter le plan d'action complet en PDF ou Excel pour vos comptes-rendus."
                }
            ];

            let currentStep = 0;
            
            // Create Overlay Elements if not exist
            let overlay = document.querySelector('.tour-backdrop');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.className = 'tour-backdrop';
                document.body.appendChild(overlay);
                
                const tooltip = document.createElement('div');
                tooltip.className = 'tour-tooltip';
                tooltip.innerHTML = `
                    <h4 id="tour-title"></h4>
                    <p id="tour-text"></p>
                    <div class="tour-nav">
                        <button class="tour-btn tour-btn-skip" onclick="endTour()">Fermer</button>
                        <button class="tour-btn tour-btn-next" onclick="nextTourStep()">Suivant</button>
                    </div>
                `;
                document.body.appendChild(tooltip);
            }

            // Expose control functions
            window.endTour = function() {
                document.querySelector('.tour-backdrop').style.display = 'none';
                document.querySelector('.tour-tooltip').style.display = 'none';
                // Remove highlights
                document.querySelectorAll('.tour-target').forEach(el => {
                    el.classList.remove('tour-target');
                    el.style.zIndex = '';
                });
            };

            window.nextTourStep = function() {
                currentStep++;
                if (currentStep >= steps.length) {
                    endTour();
                } else {
                    showStep(currentStep);
                }
            };

            function showStep(index) {
                const step = steps[index];
                const tooltip = document.querySelector('.tour-tooltip');
                const backdrop = document.querySelector('.tour-backdrop');
                
                // Reset previous highlights
                document.querySelectorAll('.tour-target').forEach(el => {
                    el.classList.remove('tour-target');
                    el.style.zIndex = '';
                });

                // Update text
                document.getElementById('tour-title').innerText = step.title;
                document.getElementById('tour-text').innerText = step.text;
                
                // Show layers
                backdrop.style.display = 'block';
                tooltip.style.display = 'block';

                // --- NOUVELLE LOGIQUE : CENTRAGE SYST√âMATIQUE ---
                // On place la bulle au centre de l'√©cran quoi qu'il arrive
                tooltip.style.top = '50%';
                tooltip.style.left = '50%';
                tooltip.style.transform = 'translate(-50%, -50%)';
                tooltip.style.position = 'fixed';

                // Gestion de la cible (Highlight uniquement)
                if (step.target) {
                    let targetEl = document.querySelector(step.target);
                    // Fallback logic if specific target (like a card) doesn't exist yet
                    if (!targetEl && step.fallbackTarget) {
                        targetEl = document.querySelector(step.fallbackTarget);
                    }

                    if (targetEl) {
                        // On fait d√©filer la page pour que l'√©l√©ment soit visible derri√®re la modale
                        targetEl.scrollIntoView({block: "center", inline: "center", behavior: "smooth"});

                        // On met l'√©l√©ment en surbrillance (z-index √©lev√©)
                        targetEl.classList.add('tour-target');
                        targetEl.style.zIndex = '10002'; // Au-dessus du backdrop
                    }
                }
            }

            // Start
            showStep(0);
        };


        function renderActionsList(actions) {
            if (!actions || actions.length === 0) {
                actionsList.innerHTML = '<div class="text-xs text-gray-400 italic mb-4">Aucune action d√©finie pour cet objectif.</div>';
                return;
            }

            actionsList.innerHTML = actions.map(act => `
                <div class="bg-white border-l-4 border-amber-500 shadow-sm p-3 rounded-r flex justify-between items-start group">
                    <div class="flex-1">
                        <h5 class="font-oswald text-sm text-dix-dark font-medium">${act.title}</h5>
                        <div class="flex flex-wrap gap-4 mt-2">
                            ${act.means ? `<span class="text-xs text-gray-600 font-georgia"><strong class="font-oswald text-gray-400 uppercase text-[10px]">Moyens:</strong> ${act.means}</span>` : ''}
                            ${act.owner ? `<span class="text-xs text-gray-600 font-georgia"><strong class="font-oswald text-gray-400 uppercase text-[10px]">Partenaires:</strong> ${act.owner}</span>` : ''}
                        </div>
                    </div>
                    <button onclick="deleteAction('${act.id}')" class="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            `).join('');
            
            // Re-init icons for the list
            lucide.createIcons();
        }

        function renderNotesList(notes) {
            if (!notes || notes.length === 0) {
                notesList.innerHTML = '<div class="text-xs text-gray-400 italic">Aucune note pour le moment.</div>';
                return;
            }

            notesList.innerHTML = notes.map(note => `
                <div class="bg-white border border-gray-100 p-3 rounded shadow-sm">
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-oswald text-xs text-dix-dark font-bold">${note.author}</span>
                        <span class="text-[10px] text-gray-400">${new Date(note.date).toLocaleDateString()}</span>
                    </div>
                    <p class="text-xs font-georgia text-gray-600">${note.text}</p>
                </div>
            `).join('');
        }

        // Add Action Logic
        btnAddAction.addEventListener('click', async () => {
            if (!db || !user || !currentDetailId) { alert("Erreur : Non connect√© √† la base de donn√©es."); return; }

            const title = document.getElementById('action-title').value;
            const means = document.getElementById('action-means').value;
            const owner = document.getElementById('action-partner').value;

            if (!title) { alert("L'intitul√© de l'action est requis."); return; }

            btnAddAction.disabled = true;
            btnAddAction.textContent = '...';

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'roadmap'), {
                    parentId: currentDetailId, // Link to Objective
                    type: 'Action',
                    title,
                    means,
                    owner,
                    createdAt: new Date().toISOString(),
                    userId: auth.currentUser.uid // Use auth.currentUser directly to be safe
                });
                
                // Clear inputs
                document.getElementById('action-title').value = '';
                document.getElementById('action-means').value = '';
                document.getElementById('action-partner').value = '';
                
                btnAddAction.disabled = false;
                btnAddAction.textContent = "Ajouter l'action";
                
                // Note: The UI updates automatically via onSnapshot

            } catch (e) {
                console.error("Error adding action: ", e);
                alert("Erreur lors de l'ajout: " + e.message);
                btnAddAction.disabled = false;
            }
        });

        // Add Note Logic
        btnAddNote.addEventListener('click', async () => {
            if (!db || !user || !currentDetailId) { alert("Erreur : Non connect√© √† la base de donn√©es."); return; }

            const author = document.getElementById('note-author').value;
            const text = document.getElementById('note-text').value;

            if (!author || !text) { alert("Merci de remplir votre nom et le commentaire."); return; }

            btnAddNote.disabled = true;
            btnAddNote.textContent = '...';

            const newNote = {
                author,
                text,
                date: new Date().toISOString(),
                uid: auth.currentUser.uid
            };

            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'roadmap', currentDetailId);
                await updateDoc(docRef, {
                    notes: arrayUnion(newNote)
                });
                
                document.getElementById('note-author').value = '';
                document.getElementById('note-text').value = '';
                btnAddNote.disabled = false;
                btnAddNote.textContent = 'Ajouter note';

            } catch (e) {
                console.error("Error adding note: ", e);
                alert("Erreur lors de l'ajout");
                btnAddNote.disabled = false;
            }
        });

        // Global function for onclick delete action
        window.deleteAction = async function(id) {
            if (!db || !user) return;
            if(confirm("Supprimer cette action ?")) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roadmap', id));
                } catch (e) { console.error(e); }
            }
        }


        // --- MODAL CREATE OBJECTIVE LOGIC ---
        const modal = document.getElementById('roadmap-modal');
        const saveBtn = document.getElementById('btn-save-roadmap');

        function openModal(axisId, axisName) {
            document.getElementById('modal-axis-id').value = axisId;
            document.getElementById('modal-axis-name').value = axisName;
            document.getElementById('modal-title').value = '';
            document.getElementById('modal-desc').value = '';
            modal.style.display = 'flex';
        }

        saveBtn.addEventListener('click', async () => {
            console.log("Tentative de sauvegarde..."); // Debug log
            
            // Auto-reconnect if needed
            if (!auth.currentUser) {
                console.log("Utilisateur non d√©tect√©, tentative de reconnexion...");
                try {
                    await signInAnonymously(auth);
                    console.log("Reconnexion r√©ussie !");
                } catch (e) {
                    console.error("Echec reconnexion:", e);
                    alert("Impossible de se connecter √† la base de donn√©es. V√©rifiez votre connexion internet.");
                    return;
                }
            }

            if (!db) { 
                alert("Erreur critique : Base de donn√©es non initialis√©e."); 
                return; 
            }

            const axisId = document.getElementById('modal-axis-id').value;
            const title = document.getElementById('modal-title').value;
            const desc = document.getElementById('modal-desc').value;

            if (!title) { alert('Veuillez mettre un titre'); return; }

            saveBtn.disabled = true;
            saveBtn.textContent = '...';

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'roadmap'), {
                    axisId: parseInt(axisId),
                    title,
                    desc,
                    type: 'Objectif',
                    notes: [], 
                    createdAt: new Date().toISOString(),
                    userId: auth.currentUser.uid
                });
                console.log("Sauvegarde r√©ussie !");
                modal.style.display = 'none';
            } catch (e) {
                console.error("Error adding document: ", e);
                alert("Erreur lors de l'enregistrement : " + e.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Cr√©er l\'objectif';
            }
        });

        async function deleteItem(docId) {
            if (!db || !user) return;
            try {
                // Ideally we should delete children too, but Firestore doesn't cascade.
                // For this prototype, we just delete the objective.
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'roadmap', docId));
            } catch (e) {
                console.error("Error deleting: ", e);
            }
        }

        // --- EXPORT FUNCTIONS ---
        function exportToCSV() {
            if (!roadmapData || roadmapData.length === 0) { alert("Aucune donn√©e √† exporter."); return; }
            
            // Header
            let csv = "Axe;Type;Objectif;Action;Moyens;Partenaires\n";
            
            // We need to flatten the hierarchy for CSV
            const objectives = roadmapData.filter(i => i.type === 'Objectif');
            
            objectives.forEach(obj => {
                const axis = axes.find(a => a.id === obj.axisId)?.title || "Inconnu";
                const safe = (txt) => txt ? `"${txt.replace(/"/g, '""')}"` : "";
                
                // Write Objective line
                csv += `${safe(axis)};Objectif;${safe(obj.title)};-;-;-\n`;
                
                // Write Action lines
                const objActions = roadmapData.filter(i => i.parentId === obj.id);
                objActions.forEach(act => {
                    csv += `${safe(axis)};Action;${safe(obj.title)};${safe(act.title)};${safe(act.means)};${safe(act.owner)}\n`;
                });
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "feuille_de_route_ilocc.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function printRoadmap() {
            if (!roadmapData || roadmapData.length === 0) { alert("Aucune donn√©e √† imprimer."); return; }

            const printWindow = window.open('', '_blank');
            let content = `
                <html>
                <head>
                    <title>Feuille de Route ILOCC - Export</title>
                    <style>
                        body { font-family: 'Georgia', serif; color: #333; padding: 40px; max-width: 800px; margin: 0 auto; }
                        h1 { font-family: sans-serif; text-transform: uppercase; color: #405F59; border-bottom: 4px solid #549e39; padding-bottom: 10px; }
                        h2 { font-family: sans-serif; text-transform: uppercase; color: #549e39; margin-top: 30px; font-size: 1.2rem; background: #f3f3f3; padding: 10px; page-break-after: avoid; }
                        .obj-block { border: 1px solid #ddd; margin-bottom: 20px; page-break-inside: avoid; border-left: 6px solid #549e39; }
                        .obj-header { padding: 15px; background: #fdfbf7; border-bottom: 1px solid #eee; }
                        .obj-title { font-weight: bold; font-size: 1.1rem; display: block; font-family: sans-serif; text-transform: uppercase; color: #405F59; }
                        .obj-desc { font-size: 0.9rem; margin-top: 5px; color: #666; font-style: italic; }
                        .action-list { padding: 15px; background: white; }
                        .action-item { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed #eee; display: flex; gap: 10px; align-items: start; }
                        .action-item:last-child { border-bottom: none; }
                        .action-title { font-weight: bold; font-size: 0.95rem; }
                        .action-meta { font-size: 0.8rem; color: #666; margin-top: 2px; }
                        .bullet { color: #eab308; font-size: 1.2rem; line-height: 1; }
                    </style>
                </head>
                <body>
                    <h1>Feuille de Route ILOCC</h1>
                    <p>Export du ${new Date().toLocaleDateString()}</p>
            `;

            axes.forEach(axis => {
                const objs = roadmapData.filter(i => parseInt(i.axisId) === axis.id && i.type === 'Objectif');
                if (objs.length > 0) {
                    content += `<h2>${axis.title}</h2>`;
                    objs.forEach(obj => {
                        const objActions = roadmapData.filter(i => i.parentId === obj.id);
                        
                        let actionsHtml = '';
                        if (objActions.length > 0) {
                            actionsHtml = '<div class="action-list">' + objActions.map(act => `
                                <div class="action-item">
                                    <span class="bullet">‚Ü≥</span>
                                    <div>
                                        <div class="action-title">${act.title}</div>
                                        <div class="action-meta">
                                            ${act.means ? `Moyens: ${act.means}` : ''} 
                                            ${(act.means && act.owner) ? ' | ' : ''}
                                            ${act.owner ? `Partenaires: ${act.owner}` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('') + '</div>';
                        } else {
                            actionsHtml = '<div class="action-list" style="color:#999; font-size:0.8rem;">Aucune action d√©finie.</div>';
                        }

                        content += `
                            <div class="obj-block">
                                <div class="obj-header">
                                    <span class="obj-title">${obj.title}</span>
                                    <div class="obj-desc">${obj.desc || ''}</div>
                                </div>
                                ${actionsHtml}
                            </div>
                        `;
                    });
                }
            });

            content += `
                <script>
                    window.onload = function() { window.print(); }
                <\/script>
                </body></html>
            `;

            printWindow.document.write(content);
            printWindow.document.close();
        }

        // Bind events
        document.getElementById('btn-export-csv').addEventListener('click', exportToCSV);
        document.getElementById('btn-export-pdf').addEventListener('click', printRoadmap);
    </script>
</body>
</html>
